<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>HBNå¯©åœ–è£½ç¨¿ç³»çµ±v1</title>

<!-- DOM â†’ Canvas æ“·åœ–ï¼ˆè¼¸å‡º JPG ç”¨ï¼‰ -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<style>
  @font-face {font-family: "ShopeeNotoSans-Content-M"; src: url("å­—é«”/ShopeeNotoSans(content)-Medium.ttf") format("truetype"); font-weight: 500; font-style: normal; font-display: swap;}
  @font-face {font-family: "ShopeeNotoSans-Content-B"; src: url("å­—é«”/ShopeeNotoSans(content)-Bold.ttf") format("truetype"); font-weight: 700; font-style: normal; font-display: swap;}
  @font-face {font-family: "ShopeeNotoSans-Content-R"; src: url("å­—é«”/ShopeeNotoSans(content)-Regular.ttf") format("truetype"); font-weight: 400; font-style: normal; font-display: swap;}

  :root{ --canvas-w:1200px; --canvas-h: 360px; --cta-bg:#2176FF; --cta-fg:#ffffff; }
  *{box-sizing:border-box}
  html,body{margin:0;padding:0;background:#fafafa;font-family:"ShopeeNotoSans-Content-M","Noto Sans TC",Arial,system-ui}
.wrap{max-width:var(--canvas-w);margin:24px auto;padding:0 0 60px}
	
/* ====== å·¥å…·åˆ—ï¼ˆå…©æ’ï¼‰UI åªæ”¹æ¨£å¼ï¼Œå…¶ä»–ä¸å‹• ====== */
.toolbar{
  display:flex; flex-wrap:wrap; gap:8px; align-items:center;
  background:#fff; padding:10px;
  border-radius:8px; border:1px solid #eaeaea;
  box-shadow:0 2px 5px rgba(0,0,0,0.06);
  margin-bottom:10px;
}
.toolbar label{
  font-size:13px; color:#444; display:flex; align-items:center; gap:6px;
  background:#fafafa; padding:6px 8px; border-radius:6px; border:1px solid #eee;
}

.toolbar input[type="color"]{
  border:none; width:24px; height:24px; padding:0; background:none; cursor:pointer;
}
.toolbar input[type="file"]{ font-size:12px; }
.toolbar button{
  background:#2176FF; color:#fff; border:none; padding:8px 12px;
  border-radius:6px; cursor:pointer; font-size:13px;
  box-shadow:0 2px 4px rgba(33,118,255,0.2);
}
.toolbar button:hover{ background:#1b65db; }
.note{ font-size:12px; color:#888; margin-left:5px; }

  .hr{height:1px;background:#e5e5e5;margin:18px 0}

  /* === APP ç•«å¸ƒï¼ˆå›ºå®š 1200x400ã€ç›´è§’ï¼‰ === */
  .canvas{position:relative;width:1200px;height: 360px;overflow:hidden;border-radius:0;background:#c2dff3;}
  .canvas .bg{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;z-index:0}

  /* === PC ç‰ˆä½ï¼ˆ992x165ï¼Œç´”å‰ç«¯é è¦½ï¼‰ === */
  .pc-canvas{position:relative;width:992px;height:165px;overflow:hidden;border-radius:0;background:#c2dff3;margin:10px 0 4px}
  .pc-canvas .bg{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;z-index:0}

  /* æ©«å¼ Logoï¼šæœ€å¤š 3 å€‹ï¼Œé™é«˜ 50pxã€é–“è· 15pxã€å¯¬ä¸é™ï¼ˆ.brand margin:0ï¼‰ */
  #horiz .brand{position:absolute;left:88px;top:122px;display:flex;align-items:center;gap:15px;z-index:5;margin:0}
  #horiz .brand img{max-height:48px;height:auto;width:auto;object-fit:contain}

  /* æ–¹å½¢ Logo appè¨­å®šï¼š105 x 105 ç›’ */
  #square .brand{position:absolute;left:45px;top:125px;display:flex;align-items:center;justify-content:center;z-index:5;margin:0}
  #square .logo-box{ position:absolute; inset:0; width:auto; height:auto; }
  #square .logo-box img{ width:auto !important; height:auto !important; max-width:105px; max-height:105px; object-fit:contain; display:block; }

  /* æ–‡å­—ï¼ˆå›ºå®š pxã€ä¸å…è¨±æ›è¡Œï¼‰ */
  .h1, .h2, .date{
    position:relative; z-index:5;
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    outline-offset:0;
  }
  /* é˜²æ­¢ PC é è¦½çš„ h2 è¢« flex å½±éŸ¿ */
  #pcH .h2, #pcS .h2 { display:block; align-items:normal; }

  .h1{ font-family:"ShopeeNotoSans-Content-M","Noto Sans TC",Arial;font-weight:500;font-size: 40px;line-height: 56px;letter-spacing:0px;color:#1b5e7a;text-align:left; }
  .h2{ font-family:"ShopeeNotoSans-Content-B","Noto Sans TC",Arial;font-weight:700;font-size: 60px;line-height: 68px;letter-spacing:0px;color:#0b6c4a;text-align:left;height: 72px;display:flex;align-items:center; }
  .date{ font-family:"ShopeeNotoSans-Content-M","Noto Sans TC",Arial;font-weight:500;font-size: 24px;line-height: 50px;letter-spacing:0px;color:#306b8f;text-align:left; }

  /* CTAï¼ˆAPP / SQUARE é è¨­ï¼‰ */
  .cta{
    position:absolute;right: 28px;bottom: 16px;
    display:flex; align-items:center; justify-content:center;
    width: 160px; height: 48px;
    background:var(--cta-bg); color:var(--cta-fg);
    border-radius:8px;
    font-family:"ShopeeNotoSans-Content-R";
    font-weight:400; font-size: 28px;
    line-height:1;
    user-select:none; padding:0 22px; z-index:6;
  }
  .cta .text{ display:block; line-height:1;   transform:none;
}
  .cta .triangle{
    position:absolute; right:18px; top:50%;
    transform: translateY(-50%);
    width:0; height:0; border-left:10px solid currentColor;
    border-top:9.5px solid transparent; border-bottom:9.5px solid transparent;
  }

  /* æ–‡æ¡ˆå€ï¼ˆå…©ç‰ˆçš†å›ºå®šï¼‰ */
  #horiz .stack{position:absolute;left: 100px;top: 160px;display:block;max-width:64%;}
  #square .stack{position:absolute;left: 166px;top: 132px;display:block;max-width:64%;}

  /* é–æ­»ï¼šä¸»/å‰¯/æ—¥æœŸçš„åº§æ¨™ï¼ˆå…©ç‰ˆå„è‡ªå›ºå®šæ•¸å€¼ï¼‰ */
  #horiz #h1-h{position:absolute;left: 0; top:0;top:0;}
  #horiz #h2-h{position:absolute;left: 0; top:60px;top:53px;}
  #horiz #date-h{position:absolute;left: 0; top:132px;top:117px;}

  #square #h1-s{position:absolute;left: 0; top:0px;top:-16.5px;}
  #square #h2-s{position:absolute;left: 0; top:44px;top:33.5px;}
  #square #date-s{position:absolute;left: 0; top:114px;top:100px;}

  [contenteditable="true"]{outline:2px dashed rgba(255,255,255,.0);transition:outline-color .2s}
  [contenteditable="true"].audit-error{outline:2px solid #ff4d4f !important;}
  .pill{font-size:11px;padding:2px 6px;border-radius:999px;background:#efefef;color:#444;margin-left:6px}

  /* æ§åˆ¶é¢æ¿ï¼ˆåº•éƒ¨ï¼‰ */
  .panel{
    position:fixed;display:flex;align-items:center;gap:8px;
    background:rgba(0,0,0,.6);color:#fff;padding:8px 10px;border-radius:10px;
    font-size:12px;backdrop-filter:saturate(1.2) blur(3px);z-index:9997;
  }
  .panel button,.panel input[type="checkbox"]{cursor:pointer}
  .panel button{border:0;outline:0;padding:4px 8px;background:#fff;color:#111;border-radius:6px;}
  .panel .val{min-width:42px;display:inline-block;text-align:center;background:#222;color:#fff;padding:2px 6px;border-radius:6px}
  .fs-panel{left:12px;bottom:12px;}
  .lh-panel{left:12px;bottom:56px;}
  .mg-panel{left:12px;bottom:100px;}
  .ls-panel{left:12px;bottom:144px;}
  .ux-panel{left:12px;bottom:188px;}

  /* å¯©æ ¸æç¤ºèˆ‡å·¦å´å°è¨ˆæ•¸å™¨ */
  .audit-tip{display:none;}
  .counter{
    position:absolute;left:-78px;top:0.25em;font-size:11px;line-height:1;
    background:#111;color:#fff;padding:2px 6px;border-radius:6px;
    pointer-events:none;user-select:none;
  }

  /* æµ®å‹•å­—æ•¸å°æ³¡æ³¡ */
  .float-meter{
    position:fixed; z-index:9999; background:#111; color:#fff; font-size:12px;
    padding:4px 6px; border-radius:6px; box-shadow:0 6px 18px rgba(0,0,0,.25);
    pointer-events:none; opacity:.96; display:none;
  }

  /* åœ–ç‰‡ç·¨è¼¯å™¨ï¼ˆå«å››è§’å·¥å…·ï¼‰ */
  .editor{position:absolute;inset:0;z-index:2;}
  .editor-item{position:absolute;cursor:move;}
  .editor-item img{display:block;width:100%;height:100%;object-fit:contain;pointer-events:none; image-rendering:auto;}
  .editor-bg{z-index:1;} /* åº•åœ–å±¤ */

  /* å››è§’å·¥å…·éµæ¨£å¼ï¼ˆèƒŒæ™¯å±¤ä¸é¡¯ç¤ºï¼‰ */
  .editor-item .ctrl{position:absolute;z-index:10;display:grid;place-items:center;width:28px;height:28px;border-radius:6px;background:rgba(17,17,17,.8);color:#fff;border:0;cursor:pointer;font-size:14px;line-height:1;box-shadow:0 4px 10px rgba(0,0,0,.25);} 
  .editor-item .ctrl:hover{background:#111}
  .editor-item .ctrl.del{left:6px;top:6px;}
  .editor-item .ctrl.edit{left:6px;bottom:6px;}
  .editor-item .layer-btns{position:absolute;right:6px;top:6px;display:flex;gap:6px;}
  .editor-item .layer-btns .ctrl{width:26px;height:26px;border-radius:6px;}
  .editor-item .ctrl.resize{right:6px;bottom:6px;transform:rotate(0deg);}

  /* å·¦åŠé®ç½©ï¼ˆèƒŒæ™¯å¯¦è‰²ï¼‰èˆ‡ä¸­å¤®æ¼¸å±¤ï¼ˆè¦è¼¸å‡ºï¼‰ */
  .bg-solid{position:absolute;left:0;top:0;width:600px;height: 360px;z-index:2;pointer-events:none;}
  .bg-gradient{position:absolute;width:100px;height: 360px;left:600px;top:0;pointer-events:none;z-index:3;}

  /* PC ç‰ˆä½ç”¨ï¼ˆç´”è¦–è¦ºï¼‰ï¼šç¸®æˆ 992x165 çš„é®ç½©å°ºå¯¸ */
  .pc-canvas .bg-solid{width:500px;height:165px}
  .pc-canvas .bg-gradient{height:165px;left:500px}

  /* æ›æ¨™ï¼šæ•´å¼µè¦†è“‹ï¼ˆ1200Ã—400 æˆ– 992Ã—165ï¼‰ï¼Œä¸æ””æˆªæ»‘é¼ äº‹ä»¶ */
  .mall-tag{
    position:absolute;inset:0;z-index:8;
    width:100%;height:100%;object-fit:cover;pointer-events:none;
  }
  .toggle-tag{
    position:absolute;left:3px;top:3px;z-index:9;
    width:28px;height:28px;border-radius:999px;border:0;cursor:pointer;
    background:#111;color:#fff;display:grid;place-items:center;font-size:16px;line-height:1;
    box-shadow:0 4px 10px rgba(0,0,0,.25);
  }

  /* èƒŒæ™¯ç¸®æ”¾æ§åˆ¶ï¼ˆAPP & PC éƒ½æœ‰ï¼‰ */
  .bg-scale-panel{position:absolute;right:8px;top:8px;z-index:7;display:flex;gap:6px;align-items:center;background:rgba(17,17,17,.72);color:#fff;border-radius:10px;padding:6px 8px;font-size:12px}
  .bg-scale-panel button{border:0;border-radius:6px;background:#fff;color:#111;cursor:pointer;padding:4px 8px}
  .bg-scale-panel .tag{background:#222;color:#fff;border-radius:6px;padding:2px 6px;font-weight:700}

  /* Modal / Nudge / Toast */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:9998;}
  .modal.show{display:flex;}
  .modal-panel{background:#111;border-radius:12px;padding:12px;box-shadow:0 10px 30px rgba(0,0,0,.5);color:#fff;display:flex;flex-direction:column;gap:8px;min-width:820px}
  .modal-toolbar{display:flex;flex-wrap:wrap;align-items:center;gap:14px}
  .modal-toolbar label{font-size:12px}
  .modal-actions{display:flex;gap:10px;justify-content:flex-end;align-items:center}
  .modal-actions button{border:0;border-radius:8px;padding:6px 10px;cursor:pointer}
  .btn-primary{background:#2ecc71;color:#111}
  .btn-danger{background:#e74c3c;color:#fff}
  .btn-ghost{background:#444;color:#fff}
  .checkerboard{position:relative;display:inline-block;border-radius:8px;overflow:auto;background: conic-gradient(#ccc 25%, #fff 0 50%, #ccc 0 75%, #fff 0) 0 0/20px 20px;padding:0;max-width:100%;max-height:60vh}
  #eraseCanvas{display:block;background:transparent}
  #eraseWrap{padding:0;border-radius:8px}

  .nudge{position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:9999; background:rgba(0,0,0,.55);}
  .nudge.show{display:flex;}
  .nudge-box{position:relative; width:300px; height:200px; background:#0000; border-radius:10px; overflow:hidden; box-shadow:none;}
  .nudge-box img{width:100%; height:100%; object-fit:cover; cursor:pointer; display:block;}
  .nudge-close{position:absolute; right:6px; top:6px; width:28px; height:28px; border-radius:999px; background:#111; color:#fff; border:0; cursor:pointer; font-size:16px; line-height:28px; text-align:center;}

  .toast{position:fixed;right:16px;top:16px;z-index:99999;background:#111;color:#fff;font-size:12px;padding:8px 10px;border-radius:8px;box-shadow:0 6px 20px rgba(0,0,0,.3);opacity:.98;max-width:68ch}
  .toast.ok{background:#16a34a}
  .toast.err{background:#dc2626}

  .is-exporting .panel,
  .is-exporting .bg-scale-panel,
  .is-exporting .toggle-tag,
  .is-exporting .modal,
  .is-exporting .nudge { display:none !important; }

  .no-underlay .bg-solid, .no-underlay .bg-gradient{ display:none !important; }

  .pending-underlay .bg-solid,
  .pending-underlay .bg-gradient{ display:none !important; }

  /* ======================= PC é è¦½ï¼ˆæ©«å¼ï¼‰ ======================= */
  #pcH .brand{
    position:absolute; left:128px; top:38.8px;
    width:80px; height:80px; display:flex; align-items:center; justify-content:center; z-index:5; margin:0;
  }
  #pcH .brand img{width:100%;height:100%;object-fit:contain}
  #pcH .stack{ position:absolute; left:227.7px; top:38.8px; max-width:66%; }
  #pcH #ph1{ position:absolute; left:0; top:0; font-family:"ShopeeNotoSans-Content-M","Noto Sans TC",Arial; font-weight:500; font-size:40pt; line-height:1; }
  #pcH #ph2{ position:absolute; left:0; top:33px; font-family:"ShopeeNotoSans-Content-B","Noto Sans TC",Arial; font-weight:700; font-size:60pt; line-height:1; }
  #pcH #pdate{ position:absolute; left:0; top:75px; font-family:"ShopeeNotoSans-Content-M","Noto Sans TC",Arial; font-weight:500; font-size:24px; line-height:1; }
  #pcH .cta{
    position:absolute; right: 28px; bottom: 16px;
    width: 160px; height: 48px; border-radius:6px;
    font-family:"ShopeeNotoSans-Content-R"; font-weight:400; font-size: 28px;
    padding:0 18px; white-space:nowrap;
  }
  #pcH .cta .triangle{
    right:10px; border-left:5px solid currentColor;
    border-top:5px solid transparent; border-bottom:5px solid transparent; white-space:nowrap;
  }

  /* ======================= PC é è¦½ï¼ˆæ–¹å¼ï¼‰ ======================= */
  #pcS .brand{
    position:absolute; left:128px; top:38.8px;
    width:80px; height:80px; display:flex; align-items:center; justify-content:center; z-index:5; margin:0;
  }
  #pcS .brand img{width:100%;height:100%;object-fit:contain}
  #pcS .stack{ position:absolute; left:227.7px; top:38.8px; max-width:66%; }
  #pcS #ps1{ position:absolute; left:0; top:0; font-family:"ShopeeNotoSans-Content-M","Noto Sans TC",Arial; font-weight:500; font-size:27px; line-height:1; }
  #pcS #ps2{ position:absolute; left:0; top:35.8px; font-family:"ShopeeNotoSans-Content-B","Noto Sans TC",Arial; font-weight:700; font-size:34px; line-height:1; }
  #pcS #psdate{ position:absolute; left:0; top:75.8px; font-family:"ShopeeNotoSans-Content-M","Noto Sans TC",Arial; font-weight:500; font-size:21px; line-height:1; }
  #pcS .cta{
    position:absolute; right: 28px; bottom: 16px;
    width: 160px; height: 48px; border-radius:6px;
    font-family:"ShopeeNotoSans-Content-R"; font-weight:400; font-size: 28px;
    padding:0 18px; white-space:nowrap;
  }
  #pcS .cta .triangle{
    right:10px; border-left:5px solid currentColor;
    border-top:5px solid transparent; border-bottom:5px solid transparent; white-space:nowrap;
  }
	/* éš±è—ã€Œåœ–å±¤ç½®å‰ã€é‚£é¡† â–² */
.editor-item .layer-btns .ctrl[title="åœ–å±¤ç½®å‰"]{
  display: none !important;
}
/* å¯é¸ï¼šå…©é¡†è®Šä¸€é¡†æ™‚ï¼Œç¸®å°ä¸€é»é–“è· */
.editor-item .layer-btns{ gap: 0; }
.editor-item .layer-btns .ctrl[title="åœ–å±¤ç½®å¾Œ"]{
  position: relative;
  right: 0px;  /* è² å€¼å¾€å³ã€æ­£å€¼å¾€å·¦ */
}

/* PC ç‰ˆ ghost å•†å“åœ–çš„å³ä¸‹è§’ç¸®æ”¾æŠŠæ‰‹ï¼ˆèˆ‡ APP ä¸€è‡´æ¨£å¼ï¼‰ */
.editor-item.ghost .ctrl.resize{ right:6px; bottom:6px; }

</style>

<!-- Modified: applied hbn-like frontend sizes/coords (best-effort). -->

<!-- Assistant-injected: temporarily hide PC horizontal preview and "æ–¹å¼ Banner (åœ–äºŒ)" visually (keeps elements in DOM). -->
<style id="assistant-hide-preview">
/* Broad selectors to cover common naming patterns used in templates */
#pc, #pc-preview, .pc-preview, .preview-pc, .preview--pc,
#horiz .banner-2, #horiz .banner2, .banner-2, .banner2, .method-banner, .æ–¹å¼-banner,
#banner2, #banner-2, .way-banner, .banner--second, .banner-image-2,
[data-role="banner-2"], [data-banner="2"], .img-banner-2 {
  display: none !important;
  visibility: hidden !important;
  pointer-events: none !important;
}

/* Keep layout space if needed: if you prefer to collapse, use display:none (above). 
   If you'd rather keep the space but hide content, comment out display:none and use opacity:0 instead. */
</style>


<!-- Assistant-injected: APP(Horiz) 1200x360 + precise layout coordinates (logo/stack/h1-h2-date/CTA) -->
<style id="assistant-app-horiz-layout">
  /* APP Horizontal canvas size */
  #horiz{ width:1200px !important; height:360px !important; }

  /* Logo block (max 3) */
  #horiz .brand{ left:98.5px !important; top:95px !important; }

  /* Text stack container */
  #horiz .stack{ left:98.5px !important; top:142px !important; }

  /* Text positions (absolute X/Y achieved via stack left/top + inner offsets) */
  #horiz #h1-h{ left:0 !important; top:2 !important; }          /* (98.5, 151) */
  #horiz #h2-h{ left:0 !important; top:50px !important; }        /* (98.5, 200) */
  #horiz #date-h{ left:0 !important; top:117px !important; }     /* (98.5, 271) */

  /* CTA (APP) */
  

  /* Arrow size = 10px */
  #horiz #cta-h .triangle{
    border-left-width:10px !important;
  }
</style>


<!-- Assistant update: CTA absolute position X=940 Y=291 on 1200x360 canvas -->
<style id="assistant-cta-xy-override">
  /* With canvas 1200x360 and CTA 238x44: X=940 => right=22, Y=291 => bottom=25 */
  
</style>


<!-- Assistant: Hide PC preview content (keep DOM, no deletion) -->
<style id="assistant-hide-pc-preview">
  /* Hide PC preview blocks but keep structure */
  #pcH,
  #pcS {
    display: none !important;
    visibility: hidden !important;
    pointer-events: none !important;
  }

  /* Hide their titles */
  h3 + #pcH,
  h3 + #pcS {
    display: none !important;
  }

  h3:has(+ #pcH),
  h3:has(+ #pcS) {
    display: none !important;
  }
</style>


<!-- Assistant: Export-aligned CTA (fix html2canvas baseline) + move CTA up 0.5px -->

<!-- Assistant: Export-aligned CTA (pixel-perfect) + move CTA up 0.5px + ensure text+arrow centered inside CTA -->
<style id="assistant-export-aligned">
  /* Ensure canvas baseline is 1200x360 export-consistent */
  .canvas{ height:360px !important; }
  #horiz{ width:1200px !important; height:360px !important; }

  /* CTA absolute position: X=940, Y=291 on 1200x360, with CTA 238x44
     right = 22, bottom = 25; move up 0.5px => bottom = 25.5 */
  

  /* Text: no Y transform (export drift), no X transform */
  #horiz #cta-h .text{
  position: relative;
  top: -2px;   /* æ”¹æˆ -0.5px / -1px / -2px è¦–è¦ºå¾®èª¿ */
	  right: 6px;


  /* Arrow: inline element (not absolute), vertically centered by flex */
  #horiz #cta-h .triangle{
    position:static !important;
    top:auto !important;
    right:auto !important;
    transform:none !important;
    width:0 !important;
    height:0 !important;
    border-left-width:10px !important;
    border-top-width:9.5px !important;
    border-bottom-width:9.5px !important;
    flex:0 0 auto !important;
  }
</style>


<!-- Assistant: Make "æ–¹å¼ HBN" CTA match Horizontal HBN CTA spec (export-aligned) -->
<style id="assistant-square-cta-like-horiz">
  

  #square #cta-s .text{
    display:inline-block !important;
    position:relative !important;
    top:-2px !important;
    transform:none !important;
    white-space:nowrap !important;
  }

  #square #cta-s .triangle{
    position:static !important;
    top:auto !important;
    right:auto !important;
    transform:none !important;

    width:0 !important;
    height:0 !important;
    border-left-width:10px !important;
    border-top-width:9.5px !important;
    border-bottom-width:9.5px !important;
    flex:0 0 auto !important;
  }
</style>


<!-- Assistant: Unified CTA (shared for horiz + square) -->
<style id="assistant-unified-cta">
  /* å…±ç”¨ CTA è¦æ ¼ï¼ˆ1200x360 ç•«å¸ƒåŸºæº–ï¼‰ */
  .cta{
    position:absolute !important;

    width:238px !important;
    height:44px !important;

    right:22px !important;
    bottom:25.5px !important;

    display:flex !important;
    align-items:center !important;
    justify-content:center !important;
    gap:10px !important;
    padding:0 16px !important;

    font-family:"ShopeeNotoSans-Content-R";
    font-weight:400;
    font-size:29px !important;
    line-height:1 !important;

    border-radius:8px;
  }

  .cta .text{
    position:relative;
    top:-2px;
    white-space:nowrap;
  }

  .cta .triangle{
    position:static !important;
    transform:none !important;
    border-left-width:10px !important;
    border-top-width:9.5px !important;
    border-bottom-width:9.5px !important;
    flex:0 0 auto;
  }
</style>


<!-- Assistant: Export/logo no distortion (match frontend display exactly) -->
<style id="assistant-logo-no-distort">
  /* Do not force square logo to 105x105; keep aspect ratio */
  #square .logo-box{ width:auto !important; height:auto !important; }
  #square .logo-box img{ width:auto !important; height:auto !important; max-width:105px; max-height:105px; object-fit:contain; display:block; }
</style>


<!-- Assistant: Square logo upload centered (no distortion) -->
<style id="assistant-square-logo-centered">
  #square .logo-box{
    width:105px !important;
    height:105px !important;
    display:flex !important;
    align-items:center !important;
    justify-content:center !important;
    overflow:hidden !important;
  }
  #square .logo-box img{
    max-width:100% !important;
    max-height:100% !important;
    width:auto !important;
    height:auto !important;
    object-fit:contain !important;
    display:block !important;
  }
</style>

</head>
<body>
  <div class="wrap">
    <h2>æ©«å¼HBN</h2>

    <!-- ç¬¬ä¸€æ’ï¼šé¡è‰² -->
    <div class="toolbar">
      <label>ä¸»æ¨™è‰²ï¼š<input id="h1-color-horiz" type="color" value="#1b5e7a"></label>
      <label>å‰¯æ¨™è‰²ï¼š<input id="h2-color-horiz" type="color" value="#0b6c4a"></label>
      <label>æ—¥æœŸè‰²ï¼š<input id="date-color-horiz" type="color" value="#306b8f"></label>
      <label>CTAåº•è‰²ï¼š<input id="cta-bg-h" type="color" value="#2176FF"></label>
      <label>CTAå­—è‰²ï¼š<input id="cta-fg-h" type="color" value="#ffffff"></label>
      <label>èƒŒæ™¯è‰²ï¼š<input id="bg-color-h" type="color" value="#c2dff3"></label>
      <button id="dl-h" type="button" style="margin-left:auto;">ä¸‹è¼‰APPç‰ˆï¼ˆâ‰¤200KBï¼‰</button> 
    </div>

    <!-- ç¬¬äºŒæ’ï¼šä¸Šå‚³ -->
    <div class="toolbar">
      <label>LOGOï¼ˆæ©«ï¼Œæœ€å¤š 3ï¼‰ï¼š<input id="logo-horiz" type="file" accept="image/*" multiple></label>
      <label>åº•åœ–ï¼š<input id="bg-horiz" type="file" accept="image/*"></label>
      <label>å•†å“åœ–ï¼ˆæœ€å¤š3ï¼‰ï¼š<input id="items-h" type="file" accept="image/*" multiple></label>
      <span class="note">ä¸»æ¨™é™8å­—ã€å‰¯æ¨™é™7å­—ã€æ—¥æœŸé™14å­—ï¼ˆè‹±æ•¸ç®—0.5å­—ï¼‰</span>
    </div>

    <!-- APP æ©«å¼ -->
    <div id="horiz" class="canvas pending-underlay">
      <img class="bg" id="bgH" src="ç¨‹å¼æª”æ¡ˆ/æ©«BG-APP.png" alt="èƒŒæ™¯" />
      <div class="editor" id="editorH">
        <div class="bg-solid" id="solidH"></div>
        <div class="bg-gradient" id="gradH"></div>
      </div>

      <img class="mall-tag" id="tagH" src="ç¨‹å¼æª”æ¡ˆ/ç´…å•†åŸ.PNG" alt="å•†åŸæ›æ¨™">
      <button class="toggle-tag" data-target="tagH" title="æ›è‰²">ğŸ¨</button>

      <div class="brand" id="brandH"></div>
      <div class="stack">
        <div id="h1-h" class="h1" contenteditable="true" data-limit="8" data-role="h1">99è³¼ç‰©ç¯€é–‹è·‘<span class="counter" aria-hidden="true"></span></div>
        <div id="h2-h" class="h2" contenteditable="true" data-limit="7" data-role="h2">æ»¿$990äº«8æŠ˜<span class="counter" aria-hidden="true"></span></div>
        <div id="date-h" class="date" contenteditable="true" data-limit="14" data-role="date">9/9 - 9/11<span class="counter" aria-hidden="true"></span></div>
      </div>
      <div class="cta" id="cta-h"><span class="text">æ”¾å¿ƒè²· å®‰å¿ƒé€€</span><span class="triangle"></span></div>

      <div class="bg-scale-panel" id="bgScaleH" hidden>
        <span class="tag">èƒŒæ™¯åœ–å°ºå¯¸</span>
        <button type="button" data-step="-0.05">â€“</button>
        <span id="bgScaleValH">100%</span>
        <button type="button" data-step="0.05">+</button>
      </div>
    </div>

    <!-- PC æ©«å¼ -->
    <h3 style="margin:10px 0 6px">PC ç‰ˆä½é è¦½ï¼ˆæ©«å¼ï¼‰</h3>
    <div id="pcH" class="pc-canvas pending-underlay" aria-hidden="false">
      <img class="bg" id="bgPH" src="ç¨‹å¼æª”æ¡ˆ/æ©«BG-PC.png" alt="PC èƒŒæ™¯" />
      <div class="editor" id="editorPH">
        <div class="bg-solid" id="solidPH"></div>
        <div class="bg-gradient" id="gradPH"></div>
      </div>
      <img class="mall-tag" id="tagPH" src="ç¨‹å¼æª”æ¡ˆ/ç´…å•†åŸæ›æ¨™pcç‰ˆ.png" alt="å•†åŸæ›æ¨™">
      <button class="toggle-tag" data-target="tagPH" title="æ›è‰²">ğŸ¨</button>

      <div class="brand" id="brandPH"><img id="brandPHImg" /></div>

      <div class="stack" style="max-width:66%">
        <div id="ph1" class="h1">ï¼ˆPCï¼‰ä¸»æ¨™ç¤ºæ„</div>
        <div id="ph2" class="h2">ï¼ˆPCï¼‰å‰¯æ¨™ç¤ºæ„</div>
        <div id="pdate" class="date">09/01 - 09/30</div>
      </div>

      <div class="cta" id="cta-ph"><span class="text">æ”¾å¿ƒè²· å®‰å¿ƒé€€</span><span class="triangle"></span></div>

      <!-- PC ç¸®æ”¾é¢æ¿ï¼ˆæ–°ï¼‰ -->
      <div class="bg-scale-panel" id="bgScalePH" hidden>
        <span class="tag">èƒŒæ™¯åœ–å°ºå¯¸</span>
        <button type="button" data-step="-0.05">â€“</button>
        <span id="bgScaleValPH">100%</span>
        <button type="button" data-step="0.05">+</button>
      </div>
    </div>

    <div class="hr"></div>

    <h2>æ–¹å¼ HBN</h2>

    <!-- ç¬¬ä¸€æ’ï¼šé¡è‰² -->
    <div class="toolbar">
      <label>ä¸»æ¨™è‰²ï¼š<input id="h1-color-square" type="color" value="#1b5e7a"></label>
      <label>å‰¯æ¨™è‰²ï¼š<input id="h2-color-square" type="color" value="#0b6c4a"></label>
      <label>æ—¥æœŸè‰²ï¼š<input id="date-color-square" type="color" value="#306b8f"></label>
      <label>CTAåº•è‰²ï¼š<input id="cta-bg-s" type="color" value="#2176FF"></label>
      <label>CTAå­—è‰²ï¼š<input id="cta-fg-s" type="color" value="#ffffff"></label>
      <label>èƒŒæ™¯è‰²ï¼š<input id="bg-color-s" type="color" value="#c2dff3"></label>
      <button id="dl-s" type="button" style="margin-left:auto;">ä¸‹è¼‰APPç‰ˆï¼ˆâ‰¤200KBï¼‰</button> 
    </div>

    <!-- ç¬¬äºŒæ’ï¼šä¸Šå‚³ -->
    <div class="toolbar">
      <label>LOGOï¼ˆæ–¹ 120Ã—120ï¼‰ï¼š<input id="logo-square" type="file" accept="image/*"></label>
      <label>åº•åœ–ï¼š<input id="bg-square" type="file" accept="image/*"></label>
      <label>å•†å“åœ–ï¼ˆæœ€å¤š3ï¼‰ï¼š<input id="items-s" type="file" accept="image/*" multiple></label>
      <span class="note">ä¸»æ¨™é™8å­—ã€å‰¯æ¨™é™7å­—ã€æ—¥æœŸé™14å­—ï¼ˆè‹±æ•¸ç®—0.5å­—ï¼‰</span>
    </div>

    <!-- APP æ–¹å½¢ -->
    <div id="square" class="canvas pending-underlay">
      <img class="bg" id="bgS" src="ç¨‹å¼æª”æ¡ˆ/æ–¹BG-APP.png" alt="èƒŒæ™¯" />
      <div class="editor" id="editorS">
        <div class="bg-solid" id="solidS"></div>
        <div class="bg-gradient" id="gradS"></div>
      </div>

      <img class="mall-tag" id="tagS" src="ç¨‹å¼æª”æ¡ˆ/ç´…å•†åŸ.PNG" alt="å•†åŸæ›æ¨™">
      <button class="toggle-tag"  data-target="tagS" title="æ›è‰²">ğŸ¨</button>

      <div class="brand"><div class="logo-box"><img id="brandImgS" /></div></div>
      <div class="stack">
        <div id="h1-s" class="h1" contenteditable="true" data-limit="8" data-role="h1">æŒ‡å®šå•†å‹™å“æ»¿8åƒ<span class="counter" aria-hidden="true"></span></div>
        <div id="h2-s" class="h2" contenteditable="true" data-limit="7" data-role="h2">ç™»éŒ„é€è—ç‰™å–‡å­<span class="counter" aria-hidden="true"></span></div>
        <div id="date-s" class="date" contenteditable="true" data-limit="14" data-role="date">9/1 - 9/30<span class="counter" aria-hidden="true"></span></div>
      </div>
      <div class="cta" id="cta-s"><span class="text">æ”¾å¿ƒè²· å®‰å¿ƒé€€</span><span class="triangle"></span></div>

      <div class="bg-scale-panel" id="bgScaleS" hidden>
        <span class="tag">èƒŒæ™¯åœ–å°ºå¯¸</span>
        <button type="button" data-step="-0.05">â€“</button>
        <span id="bgScaleValS">100%</span>
        <button type="button" data-step="0.05">+</button>
      </div>
    </div>

    <!-- PC æ–¹å¼ -->
    <h3 style="margin:10px 0 6px">PC ç‰ˆä½é è¦½ï¼ˆæ–¹å¼ï¼‰</h3>
    <div id="pcS" class="pc-canvas pending-underlay" aria-hidden="false">
      <img class="bg" id="bgPS" src="ç¨‹å¼æª”æ¡ˆ/æ©«BG-PC.png" alt="PC èƒŒæ™¯" />
      <div class="editor" id="editorPS">
        <div class="bg-solid" id="solidPS"></div>
        <div class="bg-gradient" id="gradPS"></div>
      </div>
      <img class="mall-tag" id="tagPS" src="ç¨‹å¼æª”æ¡ˆ/ç´…å•†åŸæ›æ¨™pcç‰ˆ.png" alt="å•†åŸæ›æ¨™">
      <button class="toggle-tag" data-target="tagPS" title="æ›è‰²">ğŸ¨</button>

      <div class="brand" id="brandPS"><img id="brandPSImg" /></div>

      <div class="stack" style="max-width:66%">
        <div id="ps1" class="h1">ï¼ˆPCï¼‰ä¸»æ¨™ç¤ºæ„</div>
        <div id="ps2" class="h2">ï¼ˆPCï¼‰å‰¯æ¨™ç¤ºæ„</div>
        <div id="psdate" class="date">09/01 - 09/30</div>
      </div>

      <div class="cta" id="cta-ps"><span class="text">é€›é€›å»</span><span class="triangle"></span></div>

      <!-- PC ç¸®æ”¾é¢æ¿ï¼ˆæ–°ï¼‰ -->
      <div class="bg-scale-panel" id="bgScalePS" hidden>
        <span class="tag">èƒŒæ™¯åœ–å°ºå¯¸</span>
        <button type="button" data-step="-0.05">â€“</button>
        <span id="bgScaleValPS">100%</span>
        <button type="button" data-step="0.05">+</button>
      </div>
    </div>
  </div>

  <!-- åº•éƒ¨æ§åˆ¶é¢æ¿ï¼ˆä¿ç•™ï¼‰ -->
  <div class="fs-panel panel" id="fsPanel">å­—ç´š
    <button type="button" class="fs-btn" data-delta="-1">â€“</button>
    <span class="val fs-val">--</span>
    <button type="button" class="fs-btn" data-delta="1">+</button>
    <span class="note" style="color:#fff;opacity:.8">é¸å–å¯ç·¨è¼¯æ–‡å­—å¾Œèª¿æ•´</span>
  </div>
  <div class="lh-panel panel" id="lhPanel">è¡Œè·
    <button type="button" class="lh-btn" data-delta="-1">â€“</button>
    <span class="val lh-val">--</span>
    <button type="button" class="lh-btn" data-delta="1">+</button>
    <span class="note" style="color:#fff;opacity:.8">å¯ç‚ºè² å€¼</span>
  </div>
  <div class="mg-panel panel" id="mgPanel">é–“è·
    <button type="button" class="mg-btn" data-delta="-1">â€“</button>
    <span class="val mg-val">--</span>
    <button type="button" class="mg-btn" data-delta="1">+</button>
    <span class="note" style="color:#fff;opacity:.8">æ®µè½é–“è·ï¼ˆmargin-topï¼Œå¯ç‚ºè² å€¼ï¼‰</span>
  </div>
  <div class="ls-panel panel" id="lsPanel">å­—è·
    <button type="button" class="ls-btn" data-delta="-1">â€“</button>
    <span class="val ls-val">--</span>
    <button type="button" class="ls-btn" data-delta="1">+</button>
    <span class="note" style="color:#fff;opacity:.8">å­—çš„é–“è·ï¼ˆletter-spacingï¼‰</span>
  </div>

  <!-- é—œé–‰æ–‡æ¡ˆåº•åœ– -->
  <div class="ux-panel panel" id="uxPanel">
    <label style="display:flex;align-items:center;gap:6px">
      <input id="toggleUnderlayH" type="checkbox" />
      é—œé–‰ã€Šæ©«å¼ã€‹æ–‡æ¡ˆåº•åœ–
    </label>
    <label style="display:flex;align-items:center;gap:6px;margin-left:10px">
      <input id="toggleUnderlayS" type="checkbox" />
      é—œé–‰ã€Šæ–¹å¼ã€‹æ–‡æ¡ˆåº•åœ–
    </label>
  </div>

  <!-- å»èƒŒ/è£åˆ‡ Modalï¼ˆä¿ç•™ï¼‰ -->
  <div class="modal" id="eraseModal" aria-hidden="true">
    <div class="modal-panel">
      <div class="modal-toolbar">
        <label><input type="radio" name="mode" value="erase" checked> æ“¦é™¤</label>
        <label><input type="radio" name="mode" value="select"> æ™ºæ…§é¸å–</label>
        <label><input type="radio" name="mode" value="crop"> è£åˆ‡</label>
        <label>ç­†åˆ·ï¼š<input id="brushSize" type="range" min="5" max="120" value="40"></label>
        <label>å®¹å·®ï¼š<input id="tolerance" type="range" min="0" max="80" value="20"></label>
        <span class="note">è£åˆ‡ï¼šæ‹–æ›³æ¡†é¸ï¼›æ™ºæ…§é¸å–ï¼šé»æ“Šæˆ–å¤šé»ï¼›æ“¦é™¤ï¼šæ‹–æ›³</span>
      </div>
      <div id="eraseWrap" class="checkerboard">
        <canvas id="eraseCanvas" width="800" height="400"></canvas>
      </div>
      <div class="modal-actions">
        <button class="btn-ghost" id="eraseReset" type="button">é‡ä½œ</button>
        <button class="btn-primary" id="cropConfirm" type="button" title="åªå¥—ç”¨è£åˆ‡ï¼Œä¸é—œé–‰è¦–çª—">ç¢ºå®šè£åˆ‡</button>
        <button class="btn-primary" id="eraseApply" type="button">å®Œæˆ</button>
        <button class="btn-danger" id="eraseCancel" type="button">å–æ¶ˆ</button>
      </div>
    </div>
  </div>

  <!-- å–æ¶ˆæç¤ºå°è¦–çª— -->
  <div class="nudge" id="cancelNudge" aria-hidden="true">
    <div class="nudge-box">
      <button class="nudge-close" id="nudgeClose" aria-label="é—œé–‰">âœ–</button>
      <img id="nudgeImg" src="ç¨‹å¼æª”æ¡ˆ/è·³å‡º.png" alt="è·³å‡ºæç¤º">
    </div>
  </div>

  <!-- æµ®å‹•å­—æ•¸å°æ³¡æ³¡ -->
  <div id="floatMeter" class="float-meter"></div>

  <!-- Toast -->
  <div id="toast" class="toast" style="display:none"></div>

<script>
  /* ========== Toastï¼ˆå¯æ¯”ç…§æµ®å‹•å­—æ•¸æ³¡æ³¡å®šä½ï¼‰ ========== */
  function showToast(msg, type='ok', ms=2000, targetEl=null){
    const t = document.getElementById('toast');
    if(!t) return;
    t.textContent = msg;
    t.className = 'toast ' + (type==='ok' ? 'ok' : 'err');

    if (targetEl) {
      const rect = targetEl.getBoundingClientRect();
      // æ”¾åœ¨ç›®æ¨™å…ƒç´ å³ä¸Šæ–¹ï¼Œç¨å¾®å¤–æ¨
      t.style.left = (rect.right + 8) + 'px';
      t.style.top  = (rect.top - 8) + 'px';
      t.style.right = 'auto';
    } else {
      // ä¿ç•™åŸæœ¬å³ä¸Šè§’é è¨­
      t.style.right = '16px';
      t.style.top   = '16px';
      t.style.left  = 'auto';
    }

    t.style.display = 'block';
    clearTimeout(showToast._tid);
    showToast._tid = setTimeout(()=>{ t.style.display='none'; }, ms);
  }

  /* ========== æª”æ¡ˆä¸Šå‚³ ========= */
  function readAsDataURL(file){
    return new Promise((resolve,reject)=>{
      const fr=new FileReader();
      fr.onload=()=>resolve(fr.result);
      fr.onerror=reject;
      fr.readAsDataURL(file);
    });
  }
  function bindUpload(inputId,targetSelector){
    const input=document.getElementById(inputId);
    if(!input) return;
    input.addEventListener('change',async e=>{
      const file=e.target.files?.[0];if(!file)return;
      const url=await readAsDataURL(file);
      const el=document.querySelector(targetSelector);
      if(el) el.src=url;
    });
  }
  function bindUploadMultiple(inputId, containerSelector, max=3){
    const input=document.getElementById(inputId);
    const container=document.querySelector(containerSelector);
    if(!input || !container) return;
    input.addEventListener('change', async e=>{
      const files = Array.from(e.target.files || []).slice(0, max);
      container.innerHTML = '';
      for(const file of files){
        const url = await readAsDataURL(file);
        const img = document.createElement('img');
        img.src = url; img.alt = 'Logo';
        container.appendChild(img);
      }
      /* åŒæ­¥ PC æ©«å¼ logo ä½¿ç”¨ç¬¬ä¸€å¼µï¼ˆè‹¥å­˜åœ¨ï¼‰ */
      const pcLogo = document.getElementById('brandPHImg');
      const first = container.querySelector('img');
      if(pcLogo && first){ pcLogo.src = first.src; }
    });
  }
/* ===========================================================
     ä¿®å¾©ç‰ˆï¼šèƒŒæ™¯ä¸Šå‚³ç¶å®š (å«è‡ªå‹•å¸è‰² + PC åŒæ­¥)
     =========================================================== */
  
  // è¼”åŠ©å‡½å¼ï¼šå¸å–åœ–ç‰‡å·¦ä¸Šè§’é¡è‰²ä¸¦åŒæ­¥
  function autoSyncBackground(imgElement, type) {
    // 1. å»ºç«‹ Canvas å¸è‰²
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = 1; canvas.height = 1;
    ctx.drawImage(imgElement, 0, 0, 1, 1, 0, 0, 1, 1);
    
    // 2. è½‰æ›æˆ Hex è‰²ç¢¼
    const [r, g, b] = ctx.getImageData(0, 0, 1, 1).data;
    const hex = "#" + [r, g, b].map(x => x.toString(16).padStart(2, '0')).join('');
    
    // 3. å‘¼å«åŸæœ¬å¯«å¥½çš„ setBgFor åŒæ­¥åº•è‰² (é€™æœƒåŒæ™‚è®Šæ›´ APP èˆ‡ PC çš„åº•è‰²/æ¼¸å±¤)
    setBgFor(type, hex);

    // 4. (é¡å¤–ä¿®å¾©) åŒæ­¥å°‡ PC ç‰ˆçš„ã€ŒèƒŒæ™¯åœ–ã€ä¹Ÿæ›æˆé€™å¼µåœ–
    if (type === 'H') {
      const pcImg = document.getElementById('bgPH');
      if(pcImg) pcImg.src = imgElement.src;
    } else {
      const pcImg = document.getElementById('bgPS');
      if(pcImg) pcImg.src = imgElement.src;
    }

    // 5. æç¤ºä½¿ç”¨è€…
    if(typeof showToast === 'function') showToast(`å·²åŒæ­¥ PC åº•è‰²èˆ‡åœ–ç‰‡ï¼š${hex}`);
  }

  // ç¶å®šæ©«å¼èƒŒæ™¯ (ä¸Šå‚³ -> è¼‰å…¥ -> è§¸ç™¼åŒæ­¥)
  bindUpload('bg-horiz', '#bgH');
  document.getElementById('bgH').onload = function() {
    // ç¢ºä¿åœ–ç‰‡æœ‰ä¾†æºæ‰åŸ·è¡Œ (é¿å…åˆå§‹è¼‰å…¥ç©ºåœ–å ±éŒ¯)
    if(this.src && this.src.startsWith('data:')) {
      autoSyncBackground(this, 'H');
    }
  };

  // ç¶å®šæ–¹å½¢èƒŒæ™¯ (ä¸Šå‚³ -> è¼‰å…¥ -> è§¸ç™¼åŒæ­¥)
  bindUpload('bg-square', '#bgS');
  document.getElementById('bgS').onload = function() {
    if(this.src && this.src.startsWith('data:')) {
      autoSyncBackground(this, 'S');
    }
  };
  /* =========================================================== */
	  
  bindUploadMultiple('logo-horiz','#brandH',3);
  bindUpload('logo-square','#brandImgS');
  /* åŒæ­¥ï¼šAPP æ–¹å½¢ logo â†’ PC æ–¹å¼ logo */
  document.getElementById('logo-square')?.addEventListener('change', async e=>{
    const f=e.target.files?.[0]; if(!f) return;
    const url=await readAsDataURL(f);
    const el=document.getElementById('brandPSImg'); if(el) el.src=url;
  });

  /* ========== é¡è‰²å·¥å…· ========= */
  function hexToRgb(hex){ const h = hex.replace('#',''); const b = h.length===3 ? h.split('').map(c=>c+c).join('') : h; return { r:parseInt(b.slice(0,2),16), g:parseInt(b.slice(2,4),16), b:parseInt(b.slice(4,6),16) }; }
  function rgbToHex(r,g,b){ return '#'+[r,g,b].map(v=>Math.max(0,Math.min(255,Math.round(v))).toString(16).padStart(2,'0')).join('').toUpperCase(); }
  function rgbToHsl(r,g,b){ r/=255; g/=255; b/=255; const max=Math.max(r,g,b), min=Math.min(r,g,b); let h,s,l=(max+min)/2; if(max===min){ h=s=0; } else { const d=max-min; s=l>0.5? d/(2-max-min) : d/(max+min); switch(max){ case r: h=(g-b)/d+(g<b?6:0); break; case g: h=(b-r)/d+2; break; case b: h=(r-g)/d+4; break; } h*=60; } return {h,s,l}; }
  function hslToRgb(h,s,l){ h/=360; let r,g,b; if(s===0){ r=g=b=l; } else { const hue2rgb=(p,q,t)=>{ if(t<0)t+=1; if(t>1)t-=1; if(t<1/6) return p+(q-p)*6*t; if(t<1/2) return q; if(t<2/3) return p+(q-p)*(2/3 - t)*6; return p; }; const q=l<.5 ? l*(1+s) : l+s - l*s; const p=2*l - q; r=hue2rgb(p,q,h+1/3); g=hue2rgb(p,q,h); b=hue2rgb(p,q,h-1/3); } return {r:Math.round(r*255), g:Math.round(g*255), b:Math.round(b*255)}; }
  function hexToHsl(hex){ const {r,g,b}=hexToRgb(hex); return rgbToHsl(r,g,b); }
  function hslToHex(h,s,l){ const {r,g,b}=hslToRgb(h,s,l); return rgbToHex(r,g,b); }
  function hexToRgba(hex, a){ const {r,g,b}=hexToRgb(hex); return `rgba(${r},${g},${b},${a})`; }
  function splitComplement(baseHex){ const {h,s,l} = hexToHsl(baseHex); const comp = (h+180)%360; const a = (comp+30)%360; const b = (comp+330)%360; const L = Math.max(0.28, Math.min(0.72, l)); const S = Math.max(0.45, s); return { a: hslToHex(a, S, L), b: hslToHex(b, S, L) }; }
  function hueShift(hex, deg){ const {h,s,l} = hexToHsl(hex); return hslToHex((h+deg+360)%360, s, l); }
  function updateSolid(editor, color){ const solid = editor.querySelector('.bg-solid'); if(solid) solid.style.background = color; }
  function updateGradient(editor, color){
    const grad = editor.querySelector('.bg-gradient');
    if(!grad) return;
    const isPc = !!editor.closest('.pc-canvas'); 
    grad.style.width = '100px';
    if (isPc) {
      grad.style.removeProperty('left');
    } else {
      grad.style.left = '600px';
    }
    grad.style.background = `linear-gradient(to right, ${color} 0%, ${hexToRgba(color,0)} 100%)`;
  }

  function applySplitToTexts(scopeId, baseHex){
    const pair = splitComplement(baseHex);
    const h1Color = hueShift(pair.b, 50);
    const others = pair.a;
    const root = document.getElementById(scopeId);
    if(!root) return;
    const h1 = root.querySelector('.h1'); const h2 = root.querySelector('.h2'); const date = root.querySelector('.date');
    if(h1) h1.style.color = h1Color;
    if(h2) h2.style.color = others;
    if(date) date.style.color = others;
    if(scopeId==='horiz'){
      document.getElementById('h1-color-horiz').value = h1Color;
      document.getElementById('h2-color-horiz').value = others;
      document.getElementById('date-color-horiz').value = others;
      document.getElementById('ph1').style.color = h1Color;
      document.getElementById('ph2').style.color = others;
      document.getElementById('pdate').style.color = others;
    }else{
      document.getElementById('h1-color-square').value = h1Color;
      document.getElementById('h2-color-square').value = others;
      document.getElementById('date-color-square').value = others;
      document.getElementById('ps1').style.color = h1Color;
      document.getElementById('ps2').style.color = others;
      document.getElementById('psdate').style.color = others;
    }
  }
function setBgFor(app, hex){
  const map = app === 'H'
    ? { appCanvas:'horiz', appEditor:'editorH', pcCanvas:'pcH', pcEditor:'editorPH', input:'bg-color-h' }
    : { appCanvas:'square', appEditor:'editorS', pcCanvas:'pcS', pcEditor:'editorPS', input:'bg-color-s' };

  // å¯«å› inputï¼ˆæ³¨æ„ï¼šç¨‹å¼è¨­å€¼ä¸æœƒè§¸ç™¼ input äº‹ä»¶ï¼‰
  const inp = document.getElementById(map.input);
  if (inp) inp.value = hex;

  // APP ç•«å¸ƒåº•è‰² & é®ç½©
  const appCanvas = document.getElementById(map.appCanvas);
  const appEditor = document.getElementById(map.appEditor);
  if (appCanvas) appCanvas.style.backgroundColor = hex;
  if (appEditor){ updateSolid(appEditor, hex); updateGradient(appEditor, hex); }

  // PC ç•«å¸ƒåº•è‰² & é®ç½©
  const pcCanvas = document.getElementById(map.pcCanvas);
  const pcEditor = document.getElementById(map.pcEditor);
  if (pcCanvas){
    pcCanvas.style.backgroundColor = hex;
    pcCanvas.classList.remove('pending-underlay');
  }
  if (pcEditor){ updateSolid(pcEditor, hex); updateGradient(pcEditor, hex); }
}

	  
	  
  function bindColor(inputId, selector, styleProp, extra){
    const inp=document.getElementById(inputId);
    if(!inp) return;
    const apply=(val)=>{ document.querySelectorAll(selector).forEach(el=>{ el.style[styleProp]=val; }); if(typeof extra === 'function') extra(val); };
    inp.addEventListener('input', e=>apply(e.target.value));
    apply(inp.value);
  }
  /* æ©«å¼è‰²å½©èˆ‡ PC æ©«å¼åŒæ­¥ */
  bindColor('h1-color-horiz','#h1-h','color', v=>document.getElementById('ph1').style.color=v);
  bindColor('h2-color-horiz','#h2-h','color', v=>document.getElementById('ph2').style.color=v);
  bindColor('date-color-horiz','#date-h','color', v=>document.getElementById('pdate').style.color=v);
  bindColor('cta-bg-h','#horiz .cta','backgroundColor', v=>document.querySelector('#pcH .cta').style.backgroundColor=v);
  bindColor('cta-fg-h','#horiz .cta','color', v=>document.querySelector('#pcH .cta').style.color=v);
  
bindColor('bg-color-h','#horiz','backgroundColor', (val)=>{
  updateSolid(document.getElementById('editorH'), val);
  updateGradient(document.getElementById('editorH'), val);
  updateSolid(document.getElementById('editorPH'), val);
  updateGradient(document.getElementById('editorPH'), val);

  // âœ… åŒæ­¥åˆ° PC æ©«å¼çš„ç•«å¸ƒåº•è‰²ï¼Œä¸¦è§£é™¤ pending
  const pcCanvasH = document.getElementById('pcH');
  if (pcCanvasH) {
    pcCanvasH.style.backgroundColor = val;
    pcCanvasH.classList.remove('pending-underlay');
  }

  applySplitToTexts('horiz', val);
});


  /* æ–¹å½¢è‰²å½©èˆ‡ PC æ–¹å¼åŒæ­¥ */
  bindColor('h1-color-square','#h1-s','color', v=>document.getElementById('ps1').style.color=v);
  bindColor('h2-color-square','#h2-s','color', v=>document.getElementById('ps2').style.color=v);
  bindColor('date-color-square','#date-s','color', v=>document.getElementById('psdate').style.color=v);
  bindColor('cta-bg-s','#square .cta','backgroundColor', v=>document.querySelector('#pcS .cta').style.backgroundColor=v);
  bindColor('cta-fg-s','#square .cta','color', v=>document.querySelector('#pcS .cta').style.color=v);
 
bindColor('bg-color-s','#square','backgroundColor', (val)=>{
  updateSolid(document.getElementById('editorS'), val);
  updateGradient(document.getElementById('editorS'), val);
  updateSolid(document.getElementById('editorPS'), val);
  updateGradient(document.getElementById('editorPS'), val);
  const pcCanvasS = document.getElementById('pcS');
  if (pcCanvasS) pcCanvasS.style.backgroundColor = val;
  applySplitToTexts('square', val);
});

  /* ========== æ§åˆ¶é¢æ¿ï¼ˆä¿ç•™ï¼‰ ========= */
  let activeEl = null;
  const fsPanel = document.getElementById('fsPanel');
  const lhPanel = document.getElementById('lhPanel');
  const mgPanel = document.getElementById('mgPanel');
  const lsPanel = document.getElementById('lsPanel');

  function updateFs(){ const val = activeEl ? Math.round(parseFloat(getComputedStyle(activeEl).fontSize)) + 'px' : '--'; fsPanel.querySelector('.fs-val').textContent = val; }
  function updateLh(){ const cs = activeEl ? getComputedStyle(activeEl) : null; lhPanel.querySelector('.lh-val').textContent = cs ? Math.round(parseFloat(cs.lineHeight || (1.2*parseFloat(cs.fontSize)))) + 'px' : '--'; }
  function updateMg(){ const mt = activeEl ? getComputedStyle(activeEl).marginTop : null; mgPanel.querySelector('.mg-val').textContent = activeEl ? Math.round(parseFloat(mt || '0')) + 'px' : '--'; }
  function updateLs(){ if(!activeEl){ lsPanel.querySelector('.ls-val').textContent='--'; return; } let ls = getComputedStyle(activeEl).letterSpacing; if(ls==='normal'||!ls) ls='0px'; lsPanel.querySelector('.ls-val').textContent = Math.round(parseFloat(ls)) + 'px'; }

  const floatMeter = document.getElementById('floatMeter');
  function getRawText(el){ const clone = el.cloneNode(true); clone.querySelectorAll('.counter,.audit-tip').forEach(n=>n.remove()); return clone.textContent.replace(/\n/g,''); }
  const hanRegex = /\p{Script=Han}/u;
  function calcUnits(str){ let units = 0; for(const ch of str){ units += hanRegex.test(ch) ? 1 : 0.5; } return units; }
  const limits = new Map([ ['h1',8], ['h2',7], ['date',14] ]);

  function showFloatMeter(el){
    const rect = el.getBoundingClientRect();
    const raw = getRawText(el);
    const units = calcUnits(raw);
    const limit = limits.get(el.dataset.role) ?? 'âˆ';
    floatMeter.textContent = `å­—æ•¸ï¼š${Math.round(units*10)/10} / ${limit}`;
    floatMeter.style.left = (rect.left + 6) + 'px';
    floatMeter.style.top  = (rect.top - 32) + 'px';
    floatMeter.style.display = 'block';
  }
  function hideFloatMeter(){ floatMeter.style.display = 'none'; }

  document.querySelectorAll('[contenteditable="true"]').forEach(el=>{
    el.addEventListener('focus', ()=>{ activeEl = el; updateFs(); updateLh(); updateMg(); updateLs(); showFloatMeter(el); });
    el.addEventListener('input', ()=>{ if(activeEl===el){ updateFs(); updateLh(); updateMg(); updateLs(); showFloatMeter(el); }});
    el.addEventListener('blur', ()=>{ if(activeEl===el){ updateFs(); updateLh(); updateMg(); updateLs(); hideFloatMeter(); }});
  });

  function isCTA(el){ return el && el.closest('.cta'); }

  fsPanel.querySelectorAll('.fs-btn').forEach(btn=>{
    btn.addEventListener('click', ()=>{ if(!activeEl || isCTA(activeEl)) return;
      const delta = Number(btn.dataset.delta||0);
      const cur = parseFloat(getComputedStyle(activeEl).fontSize)||36;
      const next = Math.max(8, Math.min(200, cur + delta));
      activeEl.style.fontSize = next + 'px';
      updateFs(); updateLh(); showFloatMeter(activeEl);
    });
  });
  lhPanel.querySelectorAll('.lh-btn').forEach(btn=>{
    btn.addEventListener('click', ()=>{ if(!activeEl || isCTA(activeEl)) return;
      const delta = Number(btn.dataset.delta||0);
      const cs = getComputedStyle(activeEl);
      const cur = parseFloat(cs.lineHeight) || (1.2 * parseFloat(cs.fontSize));
      const next = Math.max(-320, Math.min(320, cur + delta));
      activeEl.style.lineHeight = next + 'px';
      updateLh(); showFloatMeter(activeEl);
    });
  });
  mgPanel.querySelectorAll('.mg-btn').forEach(btn=>{
    btn.addEventListener('click', ()=>{ if(!activeEl || isCTA(activeEl)) return;
      const delta = Number(btn.dataset.delta||0);
      const cur = parseFloat(getComputedStyle(activeEl).marginTop)||0;
      const next = Math.max(-200, Math.min(200, cur + delta));
      activeEl.style.marginTop = next + 'px';
      updateMg(); showFloatMeter(activeEl);
    });
  });
  lsPanel.querySelectorAll('.ls-btn').forEach(btn=>{
    btn.addEventListener('click', ()=>{ if(!activeEl || isCTA(activeEl)) return;
      const delta = Number(btn.dataset.delta||0);
      let cur = getComputedStyle(activeEl).letterSpacing;
      if(cur === 'normal' || !cur) cur = '0px';
      const next = Math.max(-20, Math.min(80, (parseFloat(cur)||0) + delta));
      activeEl.style.letterSpacing = next + 'px';
      updateLs(); showFloatMeter(activeEl);
    });
  });

  /* é—œé–‰æ–‡æ¡ˆåº•åœ–é–‹é—œ */
  document.getElementById('toggleUnderlayH').addEventListener('change', (e)=>{
    document.getElementById('horiz').classList.toggle('no-underlay', e.target.checked);
    document.getElementById('pcH')?.classList.toggle('no-underlay', e.target.checked);
  });
  document.getElementById('toggleUnderlayS').addEventListener('change', (e)=>{
    document.getElementById('square').classList.toggle('no-underlay', e.target.checked);
    document.getElementById('pcS')?.classList.toggle('no-underlay', e.target.checked);
  });

  /* ===== ç¦ç”¨/æ›¿æ›èˆ‡å­—æ•¸ï¼ˆä¿ç•™ï¼Œä¸¦è®“ toast è²¼åœ¨ç·¨è¼¯å…ƒç´ ï¼‰ ===== */
  const replaceRules = [
    { re:/æ’’/g, to:'ç‘', toast:'åµæ¸¬åˆ°ã€Œæ’’ã€ï¼Œå·²è‡ªå‹•æ”¹ç‚ºã€Œç‘ã€' },
    { re:/è³¼ç‰©é‡‘|æŠµç”¨åˆ¸|æŠ˜åƒ¹åˆ¸|è¦çš®åˆ¸|è¦å¹£åˆ¸|æŠ˜æ‰£åˆ¸/g, to:'å„ªæƒ åˆ¸', toast:'ç¥¨åˆ¸ç¨±å‘¼å·²çµ±ä¸€ç‚ºã€Œå„ªæƒ åˆ¸ã€' },
    { re:/\bup\b/gi, to:'èµ·', toast:'åµæ¸¬åˆ° upï¼Œå·²æ”¹ç‚ºã€Œèµ·ã€' },
    { re:/å°ˆå±¬|VIP/gi, to:'å±¬æ–¼ã€é™å®š', toast:'ã€Œå°ˆå±¬ / VIPã€å·²çµ±ä¸€ç‚ºã€Œå±¬æ–¼ã€é™å®šã€' },
    { re:/æ‹š/g, to:'æ‹¼' },
    { re:/å·/g, to:'åˆ¸' },
    { re:/å‘¨/g, to:'é€±', toast:'ã€Œå‘¨ã€è«‹æ”¹ç”¨ã€Œé€±ã€' },
    { re:/[ï¼â€”â€“âˆ’]/g, to:'-' },
    { re:/[ï½]/g, to:'~' },
    { re:/(^|[^-])\s*-\s*(?!-)/g, to:'$1 - ' },
    { re:/~+/g, to:' - ', toast:'ã€Œ~ã€å·²æ”¹ç‚ºã€Œ-ã€' },
    { re:/æœ€å¼·|æœ€ä¾¿å®œ|æœ€ä½åƒ¹|æœ€å„ªæƒ |æœ€å¤§ç‰Œ|æœ€ä½³|æœ€å¤§å“ç‰Œ|æ•ˆæœæœ€å¥½|å¹´åº¦æœ€å¼·|ç«¶ç¶²æœ€ä¾¿å®œ/g, to:'è¶…', toast:'é¿å…ä½¿ç”¨ã€Œæœ€ã€å­—ï¼Œç„¡æ³•è­‰æ˜æœ€é«˜ç´šï¼Œå·²æ”¹ç‚ºã€Œè¶…ã€' },
    { re:/(\d+)\s*å€(?=\s*è¦å¹£)/g, to:'$1% ', toast:'è¦å¹£ä¸ç”¨ã€Œå€ã€å‘ˆç¾ï¼Œå·²æ”¹ç‚ºã€Œ%ã€' },
  ];
  const BLOCK = (msg)=>({type:'block', msg});
  const blockRules = [
    { re:/\$+\s*è¦å¹£/g, ...BLOCK('è¦å¹£å‰å‹¿æ”¾ $ ç¬¦è™Ÿ') },
    { re:/è¦å¹£\s*[\dï¼-ï¼™,.ï¼Œï¼]+\s*å…ƒ/g, ...BLOCK('è¦å¹£å¾Œå‹¿åŠ ã€Œå…ƒã€') },
    { re:/[\dï¼-ï¼™,.ï¼Œï¼]+\s*å…ƒ\s*è¦å¹£/g, ...BLOCK('å‹¿ä½¿ç”¨ã€Œå…ƒã€æ­é…è¦å¹£ï¼Œé‡‘é¡è«‹ä½¿ç”¨ã€Œ$ã€ç¬¦è™Ÿå–ä»£') },
    { re:/å…ƒ/g, ...BLOCK('é¿å…ä½¿ç”¨ã€Œå…ƒã€ï¼Œé‡‘é¡è«‹ç”¨ã€Œ$ã€ç¬¦è™Ÿå³å¯') },
    { re:/è³ºå–|è³£è¦å¹£|è³º/g, ...BLOCK('é¿å…ä½¿ç”¨ä»»ä½•å¯èƒ½ä½¿è¦å¹£çœ‹èµ·ä¾†æœ‰é‡‘éŒ¢åƒ¹å€¼çš„ç”¨èª') },
    { re:/å•†åŸç‹‚è³¼ç¯€|è¦çš®åƒè²¨ç¯€|è¦çš®ä¸­å…ƒç¯€|è¦çš®æ™‚å°šé€±|è¶…ç´šå“ç‰Œæ—¥/g, ...BLOCK('é¿å…ä½¿ç”¨è¦çš®ç«™ä¸Šæ´»å‹•åç¨±') },
    { re:/18è™Ÿ|25è™Ÿ|18ç¯€|25ç¯€/g, ...BLOCK('é¿å…ä½¿ç”¨è¦çš®ç«™ä¸Šæ´»å‹•åç¨±') },
    { re:/ç¨å®¶/g, ...BLOCK('éœ€ç¢ºèªåƒ…è¦çš®ç¨å®¶ï¼Œé¿å…æ³•å‹™åŠå®¢è¨´ç–‘æ…®') },
    { re:/ç¬¬ä¸€|No1|NO\.?1|N0\.?1|No\.?1/gi, ...BLOCK('é¿å…ä½¿ç”¨ No.1 / ç¬¬ä¸€å ç­‰ç„¡æ³•è­‰å¯¦ä¹‹è©ï¼Œéœ€å» å•†æä¾›å¯è­‰æ˜è³‡æ–™') },
    { re:/[!]/g, ...BLOCK('è«‹å‹¿ä½¿ç”¨ ! ç¬¦è™Ÿ') },
    { re:/[?]/g, ...BLOCK('è«‹å‹¿ä½¿ç”¨ ? ç¬¦è™Ÿ') },
    { re:/[+]/g, ...BLOCK('è«‹å‹¿ä½¿ç”¨ + ç¬¦è™Ÿ') },
    { re:/[.]/g, ...BLOCK('è«‹å‹¿ä½¿ç”¨ . ç¬¦è™Ÿ') },
    { re:/["]/g, ...BLOCK('è«‹å‹¿ä½¿ç”¨ " ç¬¦è™Ÿ') },
    { re:/[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹åå…©]/g, ...BLOCK('è«‹ä»¥é˜¿æ‹‰ä¼¯æ•¸å­—å‘ˆç¾ï¼Œé¿å…ä¸­æ–‡æ•¸å­—') },
    { re:/åƒ|ä»Ÿ|ç™¾/g, ...BLOCK('ã€Œåƒ / ä»Ÿ / ç™¾ã€è«‹æ”¹ç”¨é˜¿æ‹‰ä¼¯æ•¸å­—å‘ˆç¾') },
  ];
  const leadingZeroRe = /\b0(\d)\b/g;
  function stripLeadingZeros(text){ return text.replace(leadingZeroRe, (_, d)=> String(parseInt(d,10))); }
  function formatThousandsAll(text){ return text.replace(/\b\d{4,}\b/g, (m)=> m.replace(/\B(?=(\d{3})+(?!\d))/g, ',')); }

  document.querySelectorAll('[contenteditable="true"]').forEach(el=>{
    el.addEventListener('keydown', (e)=>{ if(e.key === 'Enter'){ e.preventDefault(); }});
  });
  function ensureCounter(el){ let c = el.querySelector('.counter'); if(!c){ c = document.createElement('span'); c.className='counter'; c.setAttribute('aria-hidden','true'); el.appendChild(c); } return c; }
  function updateCounter(el){ const raw=getRawText(el); const units=calcUnits(raw); const limit=limits.get(el.dataset.role)||Infinity; ensureCounter(el).textContent=`ï¼ˆ${Math.round(units*10)/10} / ${limit}ï¼‰`; }

  document.querySelectorAll('[contenteditable="true"]').forEach(el=>{ ensureCounter(el); updateCounter(el); });

  document.querySelectorAll('[contenteditable="true"]').forEach(el=>{
    const role = el.dataset.role;
    if(role==='h1') el.style.lineHeight='53px';
    if(role==='h2') el.style.lineHeight='40px';
    if(role==='date') el.style.lineHeight='49px';

    el.addEventListener('beforeinput', (e)=>{
      if(e.inputType === 'insertParagraph' || e.inputType === 'insertLineBreak'){ e.preventDefault(); return; }
      const limit = limits.get(el.dataset.role);
      if(!limit) return;

      let base = getRawText(el);
      const sel = window.getSelection();
      if(sel && sel.rangeCount){
        const r = sel.getRangeAt(0);
        if(r && r.toString()){ base = base.replace(r.toString(),''); }
      }
      if(e.inputType === 'insertFromPaste'){ return; }

      if(e.inputType.startsWith('insert')){
        const incoming = (e.data ?? '');
        if(calcUnits(base + incoming) > limit){
          e.preventDefault();
          showToast(`è¶…å‡ºä¸Šé™ï¼ˆ${limit}ï¼‰`, 'err', 1800, el); // ğŸ”´ æ”¹ï¼šè²¼åœ¨ç›®æ¨™å…ƒç´ æ—
          return;
        }
      }
    });

    el.addEventListener('paste', (e)=>{
      e.preventDefault();
      const text = (e.clipboardData?.getData('text/plain')||'')
        .replace(/[\u00A0\u2000-\u200B\u3000]/g,' ')
        .replace(/[\r\n]+/g,' ')
        .replace(/\s{2,}/g,' ')
        .trim();
      const limit = limits.get(el.dataset.role) ?? Infinity;
      const base = getRawText(el);
      if(calcUnits(base + text) > limit){ showToast(`è¶…å‡ºä¸Šé™ï¼ˆ${limit}ï¼‰`, 'err', 1800, el); return; } // ğŸ”´ æ”¹ï¼šè²¼åœ¨ç›®æ¨™å…ƒç´ æ—
      document.execCommand('insertText', false, text);
      updateCounter(el); showFloatMeter(el);
    });

    el.addEventListener('blur', ()=>{
      let txt = getRawText(el);
      txt = txt.replace(leadingZeroRe, (_, d)=> String(parseInt(d,10)));
      txt = formatThousandsAll(txt);
      el.textContent = txt; ensureCounter(el);

      enforceBlocks(el);
      applyReplaces(el);

      txt = getRawText(el);
      txt = txt.replace(leadingZeroRe, (_, d)=> String(parseInt(d,10)));
      txt = formatThousandsAll(txt);
      el.textContent = txt; ensureCounter(el);

      if(role==='h1') el.style.lineHeight='53px';
      if(role==='h2') el.style.lineHeight='40px';
      if(role==='date') el.style.lineHeight='49px';

      updateCounter(el);

      /* åŒæ­¥ PC é è¦½æ–‡æ¡ˆ */
      syncPcText();
      syncPcSText();
    });
  });

  function enforceBlocks(el){
    let txt = getRawText(el);
    let changed = false, hit = null;
    for(const rule of blockRules){
      if(rule.re.test(txt)){
        txt = txt.replace(rule.re, ()=>{ changed = true; hit = rule.msg; return ''; });
      }
    }
    if(changed){
      el.textContent = txt; ensureCounter(el);
      showToast(hit || 'å«ç¦ç”¨èªï¼Œå·²ç§»é™¤', 'err', 2400, el); // ğŸ”´ æ”¹ï¼šè²¼åœ¨ç›®æ¨™å…ƒç´ æ—
    }
  }
  function applyReplaces(el){
    const before = getRawText(el);
    let txt = before;
    const toasts = [];

    for (const rule of replaceRules){
      if (rule.re.test(txt)){
        txt = txt.replace(rule.re, rule.to);
        if (rule.toast) toasts.push(rule.toast);
      }
    }

    if (txt !== before){
      el.textContent = txt;
      ensureCounter(el);
    }
    if (toasts.length){
      showToast([...new Set(toasts)].join('ï¼›'), 'err', 2300, el); // ğŸ”´ æ”¹ï¼šè²¼åœ¨ç›®æ¨™å…ƒç´ æ—
    }
  }

  /* ========== å»èƒŒ/è£åˆ‡ï¼ˆä¿ç•™ï¼‰ ========= */
  const eraseModal = document.getElementById('eraseModal');
  const eraseCanvas = document.getElementById('eraseCanvas');
  const eCtx = eraseCanvas.getContext('2d', { willReadFrequently:true });
  const brushSize = document.getElementById('brushSize');
  const toleranceSlider = document.getElementById('tolerance');
  const eraseReset = document.getElementById('eraseReset');
  const eraseApply = document.getElementById('eraseApply');
  const eraseCancel = document.getElementById('eraseCancel');
  const cropConfirm = document.getElementById('cropConfirm');

  let editingTargetImg = null;
  let editingTargetBox = null;
  let originalImg = null;
  let drawn = false;
  let lastX=0, lastY=0, drawing=false;

  let cropStart=null, cropEnd=null, cropping=false;

  function openEraseEditor(imgEl){
    editingTargetImg = imgEl;
    editingTargetBox = imgEl.closest('.editor-item');
    originalImg = new Image();
    originalImg.crossOrigin = 'anonymous';
    originalImg.onload = ()=>{
      eraseCanvas.width  = Math.max(1, originalImg.naturalWidth);
      eraseCanvas.height = Math.max(1, originalImg.naturalHeight);
      eCtx.clearRect(0,0,eraseCanvas.width,eraseCanvas.height);
      eCtx.drawImage(originalImg, 0, 0, eraseCanvas.width, eraseCanvas.height);
      drawn = true;
      cropStart = cropEnd = null; cropping=false;
      eraseModal.classList.add('show');
    };
    originalImg.src = imgEl.src;
  }
  function redrawOriginal(){ if(!originalImg) return; eCtx.clearRect(0,0,eraseCanvas.width,eraseCanvas.height); eCtx.drawImage(originalImg, 0, 0, eraseCanvas.width, eraseCanvas.height); }

  eraseCanvas.addEventListener('mousedown', (e)=>{
    if(!drawn) return;
    const mode = document.querySelector('input[name="mode"]:checked').value;
    const rect = eraseCanvas.getBoundingClientRect();
    lastX = e.clientX - rect.left; lastY = e.clientY - rect.top;
    if(mode==='erase'){ drawing = true; }
    else if(mode==='select'){ floodSelect(Math.round(lastX), Math.round(lastY), Number(toleranceSlider.value)); }
    else if(mode==='crop'){ cropping = true; cropStart = {x:lastX, y:lastY}; cropEnd = {x:lastY, y:lastY}; drawCropRect(); }
  });
  window.addEventListener('mousemove', (e)=>{
    const mode = document.querySelector('input[name="mode"]:checked').value;
    const rect = eraseCanvas.getBoundingClientRect();
    const x = e.clientX - rect.left; const y = e.clientY - rect.top;
    if(mode==='erase' && drawing){
      eCtx.save(); eCtx.globalCompositeOperation = 'destination-out';
      eCtx.beginPath(); eCtx.lineCap = 'round'; eCtx.lineJoin = 'round';
      eCtx.lineWidth = Number(brushSize.value); eCtx.moveTo(lastX,lastY); eCtx.lineTo(x,y); eCtx.stroke(); eCtx.restore();
      lastX=x; lastY=y;
    }else if(mode==='crop' && cropping){ cropEnd = {x,y}; drawCropRect(); }
  });
  window.addEventListener('mouseup', ()=>{ drawing=false; cropping=false; });
  eraseReset.addEventListener('click', ()=>{ redrawOriginal(); cropStart=cropEnd=null; });

  function colorAt(data, w, x, y){ const i = (y*w + x)*4; return [data[i], data[i+1], data[i+2], data[i+3]]; }
  function withinTol(a,b,tol){ return Math.abs(a[0]-b[0])<=tol && Math.abs(a[1]-b[1])<=tol && Math.abs(a[2]-b[2])<=tol && Math.abs(a[3]-b[3])<=tol; }
  function floodSelect(sx, sy, tol=20){
    const x = Math.max(0, Math.min(eraseCanvas.width-1, Math.round(sx)));
    const y = Math.max(0, Math.min(eraseCanvas.height-1, Math.round(sy)));
    const img = eCtx.getImageData(0,0,eraseCanvas.width,eraseCanvas.height);
    const {data, width:w, height:h} = img;
    const seed = colorAt(data, w, x, y);
    const q = [[x,y]]; const visited = new Uint8Array(w*h);
    const setTransparent = (px,py)=>{ const i = (py*w+px)*4; data[i+3] = 0; };
    while(q.length){
      const [cx,cy] = q.pop(); const idx = cy*w+cx;
      if(visited[idx]) continue;
      visited[idx]=1;
      const col = colorAt(data,w,cx,cy);
      if(!withinTol(col, seed, tol)) continue;
      setTransparent(cx,cy);
      if(cx>0) q.push([cx-1,cy]); if(cx<w-1) q.push([cx+1,cy]);
      if(cy>0) q.push([cx,cy-1]); if(cy<h-1) q.push([cx,cy+1]);
    }
    eCtx.putImageData(img,0,0);
  }
  function drawCropRect(){ redrawOriginal(); if(!(cropStart && cropEnd)) return; const x=Math.min(cropStart.x, cropEnd.x); const y=Math.min(cropStart.y, cropEnd.y); const w=Math.abs(cropEnd.x - cropStart.x); const h=Math.abs(cropEnd.y - cropStart.y); eCtx.save(); eCtx.strokeStyle='#00E5FF'; eCtx.lineWidth=2; eCtx.setLineDash([6,4]); eCtx.strokeRect(x,y,w,h); eCtx.restore(); }
  function getCroppedCanvasFromSelection(){
    if(!(cropStart && cropEnd)) return null;
    redrawOriginal();
    const x = Math.max(0, Math.min(cropStart.x, cropEnd.x));
    const y = Math.max(0, Math.min(cropStart.y, cropEnd.y));
    const w = Math.min(eraseCanvas.width - x, Math.abs(cropEnd.x - cropStart.x));
    const h = Math.min(eraseCanvas.height - y, Math.abs(cropEnd.y - cropStart.y));
    if(w<=2 || h<=2) return null;
    const tmp = document.createElement('canvas'); tmp.width = w; tmp.height = h;
    const tctx = tmp.getContext('2d'); const cut = eCtx.getImageData(x,y,w,h); tctx.putImageData(cut, 0, 0);
    return tmp;
  }
  function applyCroppedToTarget(closeAfter){
    if(!editingTargetImg) return;
    const outCanvas = getCroppedCanvasFromSelection() || eraseCanvas;
    const dataUrl = outCanvas.toDataURL('image/png');

const box = editingTargetBox;
const newW = outCanvas.width;
const newH = outCanvas.height;

// é™åˆ¶é¡¯ç¤ºé«˜åº¦ä¸è¶…éç•«å¸ƒçš„ 70%
const CANVAS_H = box?.closest('.canvas')?.clientHeight || 360;
const maxH = CANVAS_H * 0.7;
const scale = 1; // fixed for pixel-perfect export alignment

editingTargetImg.onload = ()=>{
  if (box) {
    const w = Math.round(newW * scale);
    const h = Math.round(newH * scale);
    box.style.width  = w + 'px';
    box.style.height = h + 'px';
    box.dataset.fixedW = String(w);
    box.dataset.fixedH = String(h);
  }
};
editingTargetImg.style.objectFit = 'contain';
editingTargetImg.src = dataUrl;


    if(closeAfter){
      eraseModal.classList.remove('show'); editingTargetImg = null; editingTargetBox = null;
    }else{
      const tmp = new Image();
      tmp.onload = ()=>{
        eraseCanvas.width  = Math.max(1, tmp.naturalWidth);
        eraseCanvas.height = Math.max(1, tmp.naturalHeight);
        eCtx.clearRect(0,0,eraseCanvas.width,eraseCanvas.height);
        eCtx.drawImage(tmp, 0, 0, eraseCanvas.width, eraseCanvas.height);
        cropStart = cropEnd = null;
      };
      tmp.src = dataUrl;
    }
  }
  document.getElementById('eraseCancel').addEventListener('click', ()=>{ document.getElementById('cancelNudge').classList.add('show'); });
  document.getElementById('nudgeClose').addEventListener('click', ()=>{ document.getElementById('cancelNudge').classList.remove('show'); eraseModal.classList.remove('show'); editingTargetImg = null; editingTargetBox = null; });
  document.getElementById('nudgeImg').addEventListener('click', ()=>{ window.open('https://www.photoroom.com/tools/background-remover','_blank'); });
  document.getElementById('eraseApply').addEventListener('click', ()=>{ applyCroppedToTarget(true); });
  document.getElementById('cropConfirm').addEventListener('click', ()=>{ applyCroppedToTarget(false); showToast('å·²å¥—ç”¨è£åˆ‡ï¼ˆå¯ç¹¼çºŒç·¨è¼¯ï¼‰','ok',1600); });

  /* èƒŒæ™¯ç¸®æ”¾ + ç·¨è¼¯å™¨ï¼ˆAPPï¼‰ */
  async function sampleTopLeftColor(dataUrl){
    return new Promise((resolve)=>{
      const img = new Image();
      img.onload = ()=>{
        const oc = document.createElement('canvas'); oc.width = img.naturalWidth; oc.height = img.naturalHeight;
        const ctx = oc.getContext('2d'); ctx.drawImage(img, 0, 0);
        const w = img.naturalWidth, h = img.naturalHeight;
        const sx = 0, sy = 0, sw = Math.min(5, w), sh = Math.min(5, h);
        const data = ctx.getImageData(sx, sy, sw, sh).data;
        let r=0,g=0,b=0,c=0;
        for(let i=0;i<data.length;i+=4){ r+=data[i]; g+=data[i+1]; b+=data[i+2]; c++; }
        r=Math.round(r/c); g=Math.round(g/c); b=Math.round(b/c);
        resolve(rgbToHex(r,g,b));
      };
      img.src = dataUrl;
    });
  }

  function setupEditor(canvasId, editorId, productsInputId, bgInputId, bgColorInputId, scalePanelId, scaleValId){
    const canvas = document.getElementById(canvasId);
    const editor = document.getElementById(editorId);
    const productsInput = document.getElementById(productsInputId);
    const bgInput = document.getElementById(bgInputId);
    const bgColorInput = document.getElementById(bgColorInputId);
    const scalePanel = document.getElementById(scalePanelId);
    const scaleVal = document.getElementById(scaleValId);
    if(!canvas || !editor) return;

    const CANVAS_W = canvas.clientWidth;
    const CANVAS_H = canvas.clientHeight;
    let zCounter = 10;

    function fitCoverSize(nw, nh){
      const ratio = nw/nh;
      const cr = CANVAS_W/CANVAS_H;
      let w,h;
      if(ratio > cr){ h = CANVAS_H; w = h * ratio; }
      else{ w = CANVAS_W; h = w / ratio; }
      return {w, h};
    }

    function makeItem({url, asBackground=false, idx=0}){
      const box = document.createElement('div');
      box.className = 'editor-item' + (asBackground ? ' editor-bg' : '');
      box.style.zIndex = asBackground ? '1' : String(zCounter++);

      // â˜…â˜…â˜… æ–°å¢ï¼šç©©å®š IDï¼Œä¾› APPâ†”PC å°æ‡‰ï¼ˆåªåœ¨å•†å“åœ–ä¸Šï¼‰
      if (!asBackground) {
        box.dataset.pid = 'p_' + Math.random().toString(36).slice(2);
      }

      const img = document.createElement('img');
      img.src = url;
      img.style.objectFit = 'contain';

      const delBtn  = document.createElement('button'); delBtn.className='ctrl del';  delBtn.title='åˆªé™¤';        delBtn.textContent='âœ–';
      const editBtn = document.createElement('button'); editBtn.className='ctrl edit'; editBtn.title='å»èƒŒ/è£åˆ‡';  editBtn.textContent='âœ';
      const layerBox = document.createElement('div'); layerBox.className='layer-btns';
      const frontBtn = document.createElement('button'); frontBtn.className='ctrl'; frontBtn.title='åœ–å±¤ç½®å‰'; frontBtn.textContent='â–²';
      const backBtn  = document.createElement('button'); backBtn.className='ctrl';  backBtn.title='åœ–å±¤ç½®å¾Œ';  backBtn.textContent='â–¼';
      layerBox.appendChild(frontBtn); layerBox.appendChild(backBtn);

      const resizeBtn = document.createElement('button'); resizeBtn.className='ctrl resize'; resizeBtn.title='æ‹‰å¤§/æ‹‰å°'; resizeBtn.textContent='â†—';

      box.appendChild(img);
      if(!asBackground){
        box.appendChild(delBtn);
        box.appendChild(editBtn);
        box.appendChild(layerBox);
        box.appendChild(resizeBtn);
      }
      editor.appendChild(box);

      img.onload = ()=>{
        const ratio = img.naturalWidth / img.naturalHeight;
        if(asBackground){
          const s = fitCoverSize(img.naturalWidth, img.naturalHeight);
          box.style.width = s.w + 'px';
          box.style.height = s.h + 'px';
          box.style.left = ((CANVAS_W - s.w)/2) + 'px';
          box.style.top  = ((CANVAS_H - s.h)/2) + 'px';
          box.dataset.baseW = String(s.w);
          box.dataset.baseH = String(s.h);
          box.dataset.scale = '1';
          const bgEl = canvas.querySelector('.bg');
          if(bgEl) bgEl.style.visibility = 'hidden';
          if(scalePanel){ scalePanel.hidden = false; scaleVal.textContent = '100%'; }
          const curBg = (bgColorInput && bgColorInput.value) || getComputedStyle(canvas).backgroundColor || '#c2dff3';
          updateSolid(editor, curBg);
          updateGradient(editor, curBg);
          applySplitToTexts(canvasId, curBg);
          canvas.classList.remove('pending-underlay');
        }else{
          if(box.dataset.fixedW && box.dataset.fixedH){
            box.style.width  = box.dataset.fixedW + 'px';
            box.style.height = box.dataset.fixedH + 'px';
            if(!box.style.left) box.style.left = Math.round((CANVAS_W * (idx+1) / 4) - (parseFloat(box.dataset.fixedW)/2)) + 'px';
            if(!box.style.top)  box.style.top  = Math.round(CANVAS_H * 0.15) + 'px';
          }else{
            const targetH = CANVAS_H * 0.7;
            const targetW = targetH * ratio;
            box.style.width = targetW + 'px';
            box.style.height = targetH + 'px';
            box.style.left = Math.round((CANVAS_W * (idx+1) / 4) - (targetW/2)) + 'px';
            box.style.top  = Math.round(CANVAS_H * 0.15) + 'px';
          }
          if(parseInt(box.style.zIndex,10) < 4){ box.style.zIndex = '4'; }
        }
      };

      /* æ‹–æ‹‰ */
      let dragging=false, startX=0, startY=0, origLeft=0, origTop=0;
      box.addEventListener('mousedown', (e)=>{
        if(e.target.classList.contains('ctrl') || e.target.tagName === 'BUTTON') return;
        dragging = true;
        startX = e.clientX; startY = e.clientY;
        origLeft = parseFloat(box.style.left)||0;
        origTop  = parseFloat(box.style.top)||0;
        e.preventDefault();
      });
      window.addEventListener('mousemove', (e)=>{
        if(!dragging) return;
        const dx = e.clientX - startX;
        const dy = e.clientY - startY;
        box.style.left = (origLeft + dx) + 'px';
        box.style.top  = (origTop  + dy) + 'px';
      });
      window.addEventListener('mouseup', ()=> dragging=false);

      /* ç­‰æ¯”ç¸®æ”¾ï¼ˆå³ä¸‹ â†—ï¼‰ */
      let resizing=false, startW=0, startH=0, startRX=0, startRY=0, aspect=1;
      resizeBtn.addEventListener('mousedown', (e)=>{
        resizing = true;
        startRX = e.clientX; startRY = e.clientY;
        startW = box.clientWidth; startH = box.clientHeight; aspect = startW / startH;
        e.stopPropagation(); e.preventDefault();
      });
      window.addEventListener('mousemove', (e)=>{
        if(!resizing) return;
        const delta = Math.max(e.clientX - startRX, e.clientY - startRY);
        let newW = Math.max(20, startW + delta);
        let newH = Math.max(20, newW / aspect);
        box.style.width = newW + 'px';
        box.style.height = newH + 'px';
        box.dataset.fixedW = String(Math.round(newW));
        box.dataset.fixedH = String(Math.round(newH));
      });
      window.addEventListener('mouseup', ()=> resizing=false);

      if(!asBackground){
        delBtn.addEventListener('click', ()=>{ box.remove(); });
        editBtn.addEventListener('click', ()=>{ openEraseEditor(img); });
        frontBtn.addEventListener('click', ()=>{ box.style.zIndex = String(++zCounter); });
// æ”¹ç‰ˆï¼šç½®å¾Œ â†’ é€åˆ°åº•å±¤å•†å“ç¾¤ï¼ˆç¶­æŒ z=4ï¼Œè¦†è“‹é®ç½©ï¼‰
backBtn.addEventListener('click', ()=>{
  const parent = box.parentElement;
  if(!parent) return;
  const items = Array.from(parent.querySelectorAll('.editor-item:not(.editor-bg)'));
  const first = items[0];
  if (first && first !== box) parent.insertBefore(box, first);
  box.style.zIndex = '4';
});
}

      return box;
    }

    function scaleBackground(step){
      const bgBox = editor.querySelector('.editor-bg');
      if(!bgBox) return;
      const baseW = parseFloat(bgBox.dataset.baseW||bgBox.clientWidth);
      const baseH = parseFloat(bgBox.dataset.baseH||bgBox.clientHeight);
      let scale = parseFloat(bgBox.dataset.scale||'1');
      scale = Math.max(0.1, Math.min(5, scale + step));
      const centerX = (parseFloat(bgBox.style.left)||0) + bgBox.clientWidth/2;
      const centerY = (parseFloat(bgBox.style.top)||0)  + bgBox.clientHeight/2;
      const newW = baseW * scale; const newH = baseH * scale;
      bgBox.style.width = newW + 'px'; bgBox.style.height = newH + 'px';
      bgBox.style.left = (centerX - newW/2) + 'px';
      bgBox.style.top  = (centerY - newH/2) + 'px';
      bgBox.dataset.scale = String(scale);
      if(scaleVal) scaleVal.textContent = Math.round(scale*100) + '%';
    }
    if(scalePanel){
      scalePanel.addEventListener('click', (e)=>{
        const btn = e.target.closest('button'); if(!btn) return;
        const step = Number(btn.dataset.step||0);
        scaleBackground(step);
      });
    }

    /* å•†å“åœ–ï¼ˆAPP ç·¨è¼¯å™¨è¼‰å…¥ï¼‰ */
    if(productsInput){
      productsInput.addEventListener('change', async e=>{
        const files = Array.from(e.target.files || []).slice(0, 3);
        files.forEach(async (f, idx)=>{
          const url = await readAsDataURL(f);
          makeItem({url, asBackground:false, idx});
        });
      });
    }

    /* åº•åœ–ï¼ˆAPP ç·¨è¼¯å™¨è¼‰å…¥ï¼‰ */
    if(bgInput){
      bgInput.addEventListener('change', async e=>{
        const f = e.target.files?.[0]; if(!f) return;
        const url = await readAsDataURL(f);
        const hex = await sampleTopLeftColor(url).catch(()=>null);
        if(hex){
          if(bgColorInput){ bgColorInput.value = hex; }
          canvas.style.backgroundColor = hex;
          updateSolid(editor, hex);
          updateGradient(editor, hex);
          applySplitToTexts(canvasId, hex);
        }else{
          const cur = (bgColorInput && bgColorInput.value) || '#c2dff3';
          updateSolid(editor, cur); updateGradient(editor, cur);
        }
        const prev = editor.querySelector('.editor-bg'); if(prev) prev.remove();
        makeItem({url, asBackground:true});
      });
    }

    const initBg = (bgColorInput && bgColorInput.value) || getComputedStyle(canvas).backgroundColor || '#c2dff3';
    updateSolid(editor, initBg);
    updateGradient(editor, initBg);
    applySplitToTexts(canvasId, initBg);
  }

  // å•Ÿç”¨å…©å€‹ APP ç·¨è¼¯å™¨
  setupEditor('horiz',  'editorH', 'items-h', 'bg-horiz', 'bg-color-h', 'bgScaleH', 'bgScaleValH');
  setupEditor('square', 'editorS', 'items-s', 'bg-square', 'bg-color-s', 'bgScaleS', 'bgScaleValS');

  /* ======== PC Mirrorï¼šè®“ PC ä¹Ÿæœ‰ã€ŒèƒŒæ™¯å±¤ + ç¸®æ”¾/æ‹–æ‹‰ã€åŠŸèƒ½ï¼ˆç”± APP ä¸Šå‚³è§¸ç™¼ï¼‰ ======== */
  function setupPcMirror(pcCanvasId, pcEditorId, pcScalePanelId, pcScaleValId){
    const pcCanvas = document.getElementById(pcCanvasId);
    const pcEditor = document.getElementById(pcEditorId);
    const scalePanel = document.getElementById(pcScalePanelId);
    const scaleVal = document.getElementById(pcScaleValId);
    if(!pcCanvas || !pcEditor) return { mirrorBackground: ()=>{} };

    const PC_W = pcCanvas.clientWidth;
    const PC_H = pcCanvas.clientHeight;

    function fitCover(nw, nh){
      const r = nw/nh, cr = PC_W/PC_H;
      let w,h;
      if(r>cr){ h=PC_H; w=h*r; } else { w=PC_W; h=w/r; }
      return {w,h};
    }

    function attachDrag(box){
      let dragging=false, sx=0, sy=0, ol=0, ot=0;
      box.addEventListener('mousedown', (e)=>{
        if(e.target.closest('.ctrl')) return;
        dragging=true; sx=e.clientX; sy=e.clientY; ol=parseFloat(box.style.left)||0; ot=parseFloat(box.style.top)||0; e.preventDefault();
      });
      window.addEventListener('mousemove', (e)=>{
        if(!dragging) return;
        const dx=e.clientX-sx, dy=e.clientY-sy;
        box.style.left = (ol+dx)+'px';
        box.style.top  = (ot+dy)+'px';
      });
      window.addEventListener('mouseup', ()=> dragging=false);
    }

    function bindScale(box){
      if(!scalePanel) return;
      scalePanel.hidden = false; scaleVal.textContent = '100%';
      function doScale(step){
        const baseW = parseFloat(box.dataset.baseW||box.clientWidth);
        const baseH = parseFloat(box.dataset.baseH||box.clientHeight);
        let sc = parseFloat(box.dataset.scale||'1');
        sc = Math.max(0.1, Math.min(5, sc + step));
        const cx = (parseFloat(box.style.left)||0) + box.clientWidth/2;
        const cy = (parseFloat(box.style.top)||0)  + box.clientHeight/2;
        const nw = baseW*sc, nh = baseH*sc;
        box.style.width = nw+'px'; box.style.height = nh+'px';
        box.style.left = (cx - nw/2)+'px';
        box.style.top  = (cy - nh/2)+'px';
        box.dataset.scale = String(sc);
        scaleVal.textContent = Math.round(sc*100)+'%';
      }
      scalePanel.addEventListener('click', (e)=>{
        const btn=e.target.closest('button'); if(!btn) return;
        doScale(Number(btn.dataset.step||0));
      });
    }

    return {
      mirrorBackground: (url, hex)=>{
        pcEditor.querySelectorAll('.editor-bg').forEach(n=>n.remove());
        const box = document.createElement('div');
        box.className = 'editor-item editor-bg';
        box.style.zIndex = '1';
        const img = document.createElement('img');
        img.src = url; img.style.objectFit='contain';
        box.appendChild(img);
        pcEditor.appendChild(box);

        img.onload = ()=>{
          const s = fitCover(img.naturalWidth, img.naturalHeight);
          box.style.width = s.w+'px';
          box.style.height = s.h+'px';
          box.style.left = ((PC_W - s.w)/2)+'px';
          box.style.top  = ((PC_H - s.h)/2)+'px';
          box.dataset.baseW = String(s.w);
          box.dataset.baseH = String(s.h);
          box.dataset.scale = '1';

          const bgEl = pcCanvas.querySelector('.bg');
          if(bgEl) bgEl.style.visibility = 'hidden';

          updateSolid(pcEditor, hex);
          updateGradient(pcEditor, hex);
          if (hex) pcCanvas.style.backgroundColor = hex;

          attachDrag(box);
          bindScale(box);

          pcCanvas.classList.remove('pending-underlay');
        };
      }
    };
  }

  const mirrorH = setupPcMirror('pcH','editorPH','bgScalePH','bgScaleValPH');
  const mirrorS = setupPcMirror('pcS','editorPS','bgScalePS','bgScaleValPS');

  /* ===== APPâ†’PC åŒæ­¥èƒŒæ™¯ï¼šå»ºç«‹ PC çš„ editor-bgï¼Œå¯æ‹–æ‹‰/ç¸®æ”¾ ===== */
  document.getElementById('bg-horiz')?.addEventListener('change', async (e)=>{
    const f = e.target.files?.[0]; if(!f) return;
    const url = await readAsDataURL(f);
    const hex = (document.getElementById('bg-color-h')?.value) || '#c2dff3';
    mirrorH.mirrorBackground(url, hex);
    const pcCanvasH = document.getElementById('pcH');
    if (pcCanvasH) {
      pcCanvasH.style.backgroundColor = hex;
      pcCanvasH.classList.remove('pending-underlay');
    }
  });

  document.getElementById('bg-square')?.addEventListener('change', async (e)=>{
    const f = e.target.files?.[0]; if(!f) return;
    const url = await readAsDataURL(f);
    const hex = (document.getElementById('bg-color-s')?.value) || '#c2dff3';
    mirrorS.mirrorBackground(url, hex);
    const pcCanvasS = document.getElementById('pcS');
    if (pcCanvasS) {
      pcCanvasS.style.backgroundColor = hex;
      pcCanvasS.classList.remove('pending-underlay');
    }
  });

  /* ================== â˜…â˜…â˜… é—œéµæ”¹ç‰ˆå€ï¼šå•†å“åœ– APPâ†’PC åŒæ­¥ï¼ˆä¸é¡å°„ç§»å‹•/ç¸®æ”¾ï¼‰ ================== */
  (function(){
    function px(n){ return (isNaN(n) ? 0 : n) + 'px'; }
    function num(v){ const x = parseFloat(v); return isNaN(x) ? 0 : x; }

    // å–ä»£èˆŠç‰ˆï¼šåªåœ¨æ–°å¢/åˆªé™¤ / src è®Šæ›´æ™‚åŒæ­¥ï¼›å¿½ç•¥ style æ”¹è®Š
    function syncProductGhosts(appEditorId, pcEditorId){
      const app = document.getElementById(appEditorId);
      const pc  = document.getElementById(pcEditorId);
      if(!app || !pc) return;

      // ç‰ˆé¢å°ºå¯¸ï¼ˆæ›ç®—æ¯”ä¾‹ç”¨ï¼‰â€” åªåœ¨ã€Œé¦–æ¬¡å»ºç«‹ ghostã€æ™‚è¨ˆç®—ä¸€æ¬¡
      const appCanvas = app.closest('.canvas');
      const pcCanvas  = pc.closest('.pc-canvas');
      const AW = appCanvas?.clientWidth  || 1200;
      const AH = appCanvas?.clientHeight || 400;
      const PW = pcCanvas?.clientWidth   || 992;
      const PH = pcCanvas?.clientHeight  || 165;
      const sx = PW / AW, sy = PH / AH;

      // APP ç¾æœ‰å•†å“èˆ‡ PC æ—¢æœ‰ ghost å°ç…§
      const appItems = Array.from(app.querySelectorAll('.editor-item:not(.editor-bg)'));
      const appPids  = new Set(appItems.map(b => b.dataset.pid).filter(Boolean));
      const pcGhosts = new Map(
        Array.from(pc.querySelectorAll('.editor-item.ghost')).map(g => [g.dataset.pid, g])
      );

      // æ–°å¢æˆ–æ›´æ–°ï¼ˆåªæ›´æ–° srcï¼Œä¸è¦†è“‹ä½ç½®/å°ºå¯¸ï¼‰
      appItems.forEach((box, i) => {
        const pid = box.dataset.pid;
        if(!pid) return;

        const img = box.querySelector('img');
        if(!img) return;

        let ghost = pcGhosts.get(pid);
        if(!ghost){
          // åˆæ¬¡å»ºç«‹ï¼šä¾ APP ç•¶ä¸‹ç‹€æ…‹è¨ˆä¸€æ¬¡åˆå§‹ä½ç½®/å¤§å°ï¼ˆä¹‹å¾Œä¸å†è®Šï¼‰
          const g = document.createElement('div');
          g.className = 'editor-item ghost';
          g.dataset.pid = pid;
          g.style.cursor = 'default';
          g.style.zIndex = '4';

          const gimg = document.createElement('img');
          gimg.alt = 'ghost';
          gimg.src = img.src;
          gimg.style.objectFit = 'contain';
          g.appendChild(gimg);

          const w = num(box.style.width  || box.dataset.fixedW)  || box.clientWidth;
          const h = num(box.style.height || box.dataset.fixedH)  || box.clientHeight;
          const l = num(box.style.left);
          const t = num(box.style.top);

          g.style.width  = px(w * sx);
          g.style.height = px(h * sy);
          g.style.left   = px(l * sx);
          g.style.top    = px(t * sy);

          pc.appendChild(g);
          pcGhosts.set(pid, g);
        
          // å³ä¸‹è§’ç¸®æ”¾æŠŠæ‰‹ï¼ˆåƒ… PC ghostï¼Œèˆ‡ APP æ§åˆ¶ä½œæ³•ä¸€è‡´ï¼‰
          const resizeBtn = document.createElement('button');
          resizeBtn.className = 'ctrl resize';
          resizeBtn.title = 'æ‹‰å¤§/æ‹‰å°';
          resizeBtn.textContent = 'â†—';
          g.appendChild(resizeBtn);

          // æ‹–æ‹‰ï¼ˆåƒ… ghost è‡ªå·±ï¼Œèˆ‡ APP ç„¡é—œï¼‰
          (function attachDrag(box){
            let dragging=false, sx=0, sy=0, ol=0, ot=0;
            box.addEventListener('mousedown', (e)=>{
              if(e.target.classList.contains('ctrl') || e.target.tagName==='BUTTON') return;
              dragging=true; sx=e.clientX; sy=e.clientY;
              ol=parseFloat(box.style.left)||0; ot=parseFloat(box.style.top)||0;
              e.preventDefault();
            });
            window.addEventListener('mousemove', (e)=>{
              if(!dragging) return;
              const dx=e.clientX-sx, dy=e.clientY-sy;
              box.style.left = (ol+dx)+'px';
              box.style.top  = (ot+dy)+'px';
            });
            window.addEventListener('mouseup', ()=> dragging=false);
          })(g);

          // ç­‰æ¯”ç¸®æ”¾ï¼ˆå³ä¸‹è§’ â†—ï¼‰ï¼Œåƒ…å½±éŸ¿ PCï¼Œä¸å›å‚³ APP
          (function attachResize(handle, box){
            let resizing=false, startW=0, startH=0, startRX=0, startRY=0, aspect=1;
            handle.addEventListener('mousedown', (e)=>{
              resizing=true;
              startRX = e.clientX; startRY = e.clientY;
              startW = box.clientWidth; startH = box.clientHeight; aspect = startW / Math.max(1, startH);
              e.stopPropagation(); e.preventDefault();
            });
            window.addEventListener('mousemove', (e)=>{
              if(!resizing) return;
              const delta = Math.max(e.clientX - startRX, e.clientY - startRY);
              let newW = Math.max(20, startW + delta);
              let newH = Math.max(20, newW / aspect);
              box.style.width = newW + 'px';
              box.style.height = newH + 'px';
            });
            window.addEventListener('mouseup', ()=> resizing=false);
          })(resizeBtn, g);
}else{
          // å·²å­˜åœ¨ï¼šåªæ›´æ–°åœ–æª”ï¼Œä¸å‹• left/top/width/height
          const gimg = ghost.querySelector('img');
          if(gimg && gimg.src !== img.src){
            gimg.src = img.src;
          }
        }
      });

      // ç§»é™¤åœ¨ APP ä¸å­˜åœ¨çš„ ghost
      pcGhosts.forEach((g, pid) => {
        if(!appPids.has(pid)) g.remove();
      });
    }

    // ç°¡å–®çš„ debounce
    function debounce(fn, wait=80){
      let t=null; return function(){ clearTimeout(t); t=setTimeout(()=>fn.apply(this, arguments), wait); };
    }

    // åƒ…ç›£è½ï¼šchildListï¼ˆæ–°å¢/åˆªé™¤ï¼‰èˆ‡ img[src]ï¼ˆåœ–æª”è®Šæ›´ï¼‰ï¼›å¿½ç•¥ style
    function observeContinuous(appEditorId, pcEditorId){
      const app = document.getElementById(appEditorId);
      if(!app) return;
      const run = debounce(()=>syncProductGhosts(appEditorId, pcEditorId));

      // åˆæ¬¡åŒæ­¥
      run();

      const mo = new MutationObserver((muts)=>{
        for(const m of muts){
          if(m.type === 'childList'){ run(); break; }
          if(m.type === 'attributes' && m.attributeName === 'src' && m.target.tagName === 'IMG'){ run(); break; }
          // ä¸è™•ç† style æ”¹è®Šï¼ˆèª¿æ•´ä½ç½®/å¤§å°ï¼‰ï¼Œå› æ­¤ APP çš„æ‹–æ‹‰/ç¸®æ”¾ä¸å½±éŸ¿ PC
        }
      });
      mo.observe(app, { 
        childList:true, 
        subtree:true, 
        attributes:true, 
        attributeFilter:['src'] 
      });

      document.getElementById(appEditorId === 'editorH' ? 'items-h' : 'items-s')
        ?.addEventListener('change', run);
    }

    // å•Ÿç”¨å…©çµ„æŒçºŒåŒæ­¥ï¼ˆæ©«å¼ã€æ–¹å¼ï¼‰
    observeContinuous('editorH','editorPH');
    observeContinuous('editorS','editorPS');
  })();

  /* ===== APPâ†’PC æ—¢æœ‰åŒæ­¥ï¼ˆæ–‡å­—/CTAï¼‰ ===== */
  function syncPcText(){
    const h1 = document.getElementById('h1-h');
    const h2 = document.getElementById('h2-h');
    const date = document.getElementById('date-h');
    if(h1) document.getElementById('ph1').textContent = h1.textContent.replace(/ï¼ˆ.*?ï¼‰$/, '');
    if(h2) document.getElementById('ph2').textContent = h2.textContent.replace(/ï¼ˆ.*?ï¼‰$/, '');
    if(date) document.getElementById('pdate').textContent = date.textContent.replace(/ï¼ˆ.*?ï¼‰$/, '');
  }
  syncPcText();
  ['h1-h','h2-h','date-h'].forEach(id=>{
    const el=document.getElementById(id);
    if(el){
      el.addEventListener('input', syncPcText);
      el.addEventListener('blur', syncPcText);
    }
  });

  const ctaH = document.getElementById('cta-h');
  const ctaPH = document.getElementById('cta-ph');
  function syncCta(){
    if(!ctaH || !ctaPH) return;
    const textH = ctaH.querySelector('.text')?.textContent || 'é€›é€›å»';
    ctaPH.querySelector('.text').textContent = textH;
    ctaPH.style.backgroundColor = getComputedStyle(ctaH).backgroundColor;
    ctaPH.style.color = getComputedStyle(ctaH).color;
  }
  syncCta();
  copyHorizCtaToSquare();

  function syncPcSText(){
    const h1 = document.getElementById('h1-s');
    const h2 = document.getElementById('h2-s');
    const date = document.getElementById('date-s');
    if(h1) document.getElementById('ps1').textContent = h1.textContent.replace(/ï¼ˆ.*?ï¼‰$/, '');
    if(h2) document.getElementById('ps2').textContent = h2.textContent.replace(/ï¼ˆ.*?ï¼‰$/, '');
    if(date) document.getElementById('psdate').textContent = date.textContent.replace(/ï¼ˆ.*?ï¼‰$/, '');
  }
  syncPcSText();
  ['h1-s','h2-s','date-s'].forEach(id=>{
    const el=document.getElementById(id);
    if(el){
      el.addEventListener('input', syncPcSText);
      el.addEventListener('blur', syncPcSText);
    }
  });

  const ctaS = document.getElementById('cta-s');
  const ctaPS = document.getElementById('cta-ps');
  function syncCtaS(){
    if(!ctaS || !ctaPS) return;
    const text = ctaS.querySelector('.text')?.textContent || 'é€›é€›å»';
    ctaPS.querySelector('.text').textContent = text;
    ctaPS.style.backgroundColor = getComputedStyle(ctaS).backgroundColor;
    ctaPS.style.color = getComputedStyle(ctaS).color;
  }
  syncCtaS();


  /* ====== Assistant: Square export copies Horizontal CTA (text + colors), but exports Square canvas ====== */
  function copyHorizCtaToSquare(){
    const h = document.getElementById('cta-h');
    const s = document.getElementById('cta-s');
    if(!h || !s) return;
    const ht = h.querySelector('.text')?.textContent ?? '';
    const st = s.querySelector('.text');
    if(st && ht) st.textContent = ht;
    // copy computed colors to keep identical
    const cs = getComputedStyle(h);
    s.style.backgroundColor = cs.backgroundColor;
    s.style.color = cs.color;
  }

  /* ===== åŒ¯å‡º ===== */
  if (!HTMLCanvasElement.prototype.toBlob) {
    HTMLCanvasElement.prototype.toBlob = function (cb, type, quality) {
      const bin = atob(this.toDataURL(type, quality).split(',')[1]);
      const len = bin.length;
      const arr = new Uint8Array(len);
      for (let i = 0; i < len; i++) arr[i] = bin.charCodeAt(i);
      cb(new Blob([arr], { type: type || 'image/png' }));
    };
  }

  function withExporting(node, fn){
    node.classList.add('is-exporting');
    document.body.dataset.exporting = '1';
    return Promise.resolve().then(fn).finally(()=>{
      node.classList.remove('is-exporting');
      delete document.body.dataset.exporting;
    });
  }
  function exportIgnore(el){
    if(!el || !el.classList) return false;
    return el.classList.contains('bg-scale-panel') ||
           el.classList.contains('panel') ||
           el.classList.contains('float-meter') ||
           el.classList.contains('modal') ||
           el.classList.contains('nudge') ||
           el.classList.contains('toggle-tag') ||
           el.getAttribute('aria-hidden') === 'true' ||
           el.classList.contains('ctrl');
  }

  async function downloadJpgFor(canvasId, bgColorInputId, filename){
    const node = document.getElementById(canvasId);
    if(!node){ showToast('æ‰¾ä¸åˆ°ç•«å¸ƒ', 'err', 2000); return; }

    const isFileProto = location.protocol === 'file:';
    if(isFileProto){
      showToast('åµæ¸¬åˆ°ä»¥æª”æ¡ˆæ–¹å¼é–‹å•Ÿï¼ˆfile://ï¼‰ã€‚è‹¥åœ–ç‰‡éä¸Šå‚³ä¾†æºï¼Œè¼¸å‡ºå¯èƒ½å¤±æ•—ï¼Œå»ºè­°ç”¨æœ¬æ©Ÿä¼ºæœå™¨é–‹å•Ÿã€‚', 'err', 3800);
    }

    try{ if(document.fonts && document.fonts.ready) await document.fonts.ready; }catch{}

    const scale = 1; // fixed for pixel-perfect export alignment
    const baseOptions = {
      backgroundColor: null,
      scale,
      useCORS: true,
      allowTaint: false,
      removeContainer: true,
      letterRendering: true,
      logging: false,
      ignoreElements: exportIgnore,
      onclone: (doc)=>{
        doc.querySelectorAll('.panel,.bg-scale-panel,.toggle-tag').forEach(el=>el?.remove());
        doc.body.classList.add('export-clone');
      }
    };

    async function tryRender(options){ return await html2canvas(node, options); }

    async function exportFrom(snap){
      const outC = document.createElement('canvas');
      outC.width = snap.width; outC.height = snap.height;
      const ctx = outC.getContext('2d');
      const bgHex = (document.getElementById(bgColorInputId)?.value) || '#ffffff';
      const {r,g,b} = hexToRgb(bgHex);
      ctx.fillStyle = `rgb(${r},${g},${b})`;
      ctx.fillRect(0,0,outC.width,outC.height);
      ctx.drawImage(snap, 0, 0);

      function toBlob(type, quality){
        return new Promise(res => outC.toBlob(b=>res(b), type, quality));
      }

      // 1) å…ˆå˜—è©¦ PNGï¼ˆç„¡å£“ç¸®ã€æœ€é«˜ç•«è³ªï¼‰
      let blob = await toBlob('image/png');
      let outName = (filename || 'banner.png');

      if (blob && blob.size > 200*1024){
        // 2) è‹¥è¶…é 200KB æ‰æ”¹ç‚º JPEG ä¸¦é€æ­¥å£“ç¸®
        outName = outName.replace(/\.png$/i, '') + '.jpg';
        let quality = 1.0;
        blob = await toBlob('image/jpeg', quality);
        while (blob && blob.size > 200*1024 && quality > 0.4){
          quality = Math.max(0.4, +(quality - 0.06).toFixed(2));
          blob = await toBlob('image/jpeg', quality);
        }
        if(!blob){ throw new Error('ç”¢ç”Ÿåœ–æª”å¤±æ•—'); }
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = outName;
        document.body.appendChild(a);
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        if(isIOS){ window.open(url, '_blank'); } else { a.click(); }
        a.remove(); setTimeout(()=>URL.revokeObjectURL(url), 1000);
        showToast(`å·²ä¸‹è¼‰ï¼š${Math.round(blob.size/1024)}KBï¼ˆJPEG å“è³ª ${typeof quality!=='undefined'?Math.round(quality*100):'--'}%ï¼›åŸ PNG è¶…é 200KBï¼‰`,'ok',3000);
      } else {
        // PNG åœ¨ 200KB ä»¥å…§ â†’ ç›´æ¥ä¸‹è¼‰ï¼ˆä¸å£“ç¸®ï¼‰
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = outName;
        document.body.appendChild(a);
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        if(isIOS){ window.open(url, '_blank'); } else { a.click(); }
        a.remove(); setTimeout(()=>URL.revokeObjectURL(url), 1000);
        showToast(`å·²ä¸‹è¼‰ï¼š${Math.round(blob.size/1024)}KBï¼ˆPNG ç„¡å£“ç¸®ï¼‰`,'ok',2000);
      }
    }

    try{
      await withExporting(node, async ()=>{
        try{
          const snap = await tryRender(baseOptions);
          await exportFrom(snap);
        }catch(err1){
          const msg = (err1?.message||'');
          if(/tainted canvas/i.test(msg)){
            showToast('åµæ¸¬åˆ°è·¨ä¾†æºåœ–ç‰‡ï¼Œå•Ÿå‹•ã€Œå®‰å…¨æ¨¡å¼ã€é‡è©¦ï¼ˆä¸å®‰å…¨åœ–ç‰‡å°‡ä¸è¼¸å‡ºï¼‰', 'err', 3200);
            const unsafe = [];
            node.querySelectorAll('img').forEach(img=>{
              const src = img.getAttribute('src')||'';
              const isSafe = src.startsWith('data:') || src.startsWith('blob:');
              if(!isSafe){ img.dataset._exportHidden = '1'; img.style.visibility = 'hidden'; unsafe.push(img); }
            });
            try{
              const snap2 = await tryRender({...baseOptions, allowTaint:true, useCORS:false});
              await exportFrom(snap2);
            }catch(err2){
              console.error(err2);
              showToast('ä¸‹è¼‰å¤±æ•—ï¼šè·¨ä¾†æºåœ–ç‰‡é€ æˆé™åˆ¶ã€‚è«‹ä»¥æœ¬æ©Ÿä¼ºæœå™¨é–‹å•Ÿæˆ–å°‡åœ–ç‰‡æ”¹ç‚ºä¸Šå‚³ä¾†æºï¼ˆdataURLï¼‰ã€‚', 'err', 5200);
            }finally{
              unsafe.forEach(img=>{ if(img.dataset._exportHidden==='1'){ img.style.visibility=''; delete img.dataset._exportHidden; } });
            }
          }else{
            console.error(err1);
            showToast('ä¸‹è¼‰å¤±æ•—ï¼š' + msg, 'err', 3000);
          }
        }
      });
    }catch(err){
      console.error(err);
      showToast('ä¸‹è¼‰å¤±æ•—ï¼š' + (err?.message || err), 'err', 3000);
    }
  }

  const _dlH=document.getElementById('dl-h'); if(_dlH) _dlH.addEventListener('click', ()=>downloadJpgFor('horiz','bg-color-h','horiz.jpg'));
  const _dlHPc=document.getElementById('dl-h-pc'); if(_dlHPc) _dlHPc.addEventListener('click', ()=>downloadJpgFor('pcH','bg-color-h','pc-horiz.jpg'));
  const _dlS=document.getElementById('dl-s'); if(_dlS) _dlS.addEventListener('click', ()=>{ copyHorizCtaToSquare(); downloadJpgFor('square','bg-color-s','square.jpg'); });
  const _dlSPc=document.getElementById('dl-s-pc'); if(_dlSPc) _dlSPc.addEventListener('click', ()=>downloadJpgFor('pcS','bg-color-s','pc-square.jpg'));
// ========== æ›æ¨™ç´…ï¼ç™½åˆ‡æ›ï¼ˆAPP èˆ‡ PC åŒæ­¥ï¼‰ ==========
(function(){
  const GROUPS = {
    tagH:  ['tagH','tagPH'], // æ©«å¼çµ„ï¼šAPP + PC
    tagPH: ['tagH','tagPH'],
    tagS:  ['tagS','tagPS'], // æ–¹å½¢çµ„ï¼šAPP + PC
    tagPS: ['tagS','tagPS']
  };

  function toggleTag(btn){
    const id = btn.getAttribute('data-target');
    const group = GROUPS[id] || [id];
    const imgs = group.map(g=>document.getElementById(g)).filter(Boolean);
    if(!imgs.length) return;

    imgs.forEach(img=>{
      let cur = img.getAttribute('src') || '';
      let next = cur;

      // åˆ¤æ–· APP æˆ– PC
      if(cur.includes('æ›æ¨™pcç‰ˆ')) {
        // PC ç‰ˆï¼šç´…å•†åŸæ›æ¨™pcç‰ˆ.png â†” ç™½å•†åŸæ›æ¨™pcç‰ˆ.png
        next = cur.includes('ç´…å•†åŸæ›æ¨™pcç‰ˆ')
          ? cur.replace('ç´…å•†åŸæ›æ¨™pcç‰ˆ', 'ç™½å•†åŸæ›æ¨™pcç‰ˆ')
          : cur.replace('ç™½å•†åŸæ›æ¨™pcç‰ˆ', 'ç´…å•†åŸæ›æ¨™pcç‰ˆ');
      } else {
        // APP ç‰ˆï¼šç´…å•†åŸ.PNG â†” ç™½å•†åŸ.PNG
        next = cur.includes('ç´…å•†åŸ')
          ? cur.replace('ç´…å•†åŸ', 'ç™½å•†åŸ')
          : cur.replace('ç™½å•†åŸ', 'ç´…å•†åŸ');
      }
      img.src = next;
    });

    const nowIsWhite = imgs[0].src.includes('ç™½å•†åŸ');
    showToast(`æ›æ¨™åˆ‡æ›ï¼š${nowIsWhite ? 'ç™½' : 'ç´…'}`, 'ok', 1000);
  }

  document.querySelectorAll('.toggle-tag').forEach(btn=>{
    btn.addEventListener('click', ()=>toggleTag(btn));
    btn.title = 'åˆ‡æ›æ›æ¨™ï¼ˆç´…ï¼ç™½ï¼ŒåŒæ­¥ APP èˆ‡ PCï¼‰';
  });
})();

/* ===========================================================
   ã€å¼·åŠ›ä¿®å¾©ç‰ˆã€‘èƒŒæ™¯ä¸Šå‚³åŒæ­¥é‚è¼¯ (å«å¼·åˆ¶ PC åˆ·æ–°)
   =========================================================== */

// é‡æ–°å®šç¾©ï¼šè¨­å®šé¡è‰²çš„å‡½å¼ï¼ˆç¢ºä¿èƒ½æ­£ç¢ºç§»é™¤ PC é®ç½©ï¼‰
function setBgFor(app, hex) {
  const map = app === 'H'
    ? { appCanvas:'horiz', appEditor:'editorH', pcCanvas:'pcH', pcEditor:'editorPH', input:'bg-color-h' }
    : { appCanvas:'square', appEditor:'editorS', pcCanvas:'pcS', pcEditor:'editorPS', input:'bg-color-s' };

  const inp = document.getElementById(map.input);
  if (inp) inp.value = hex;

  const appCanvas = document.getElementById(map.appCanvas);
  const appEditor = document.getElementById(map.appEditor);
  if (appCanvas) appCanvas.style.backgroundColor = hex;
  if (appEditor) { updateSolid(appEditor, hex); updateGradient(appEditor, hex); }

  const pcCanvas = document.getElementById(map.pcCanvas);
  const pcEditor = document.getElementById(map.pcEditor);
  if (pcCanvas) {
    pcCanvas.style.backgroundColor = hex;
    pcCanvas.classList.remove('pending-underlay');
  }
  if (pcEditor) { updateSolid(pcEditor, hex); updateGradient(pcEditor, hex); }
}

// åœ–ç‰‡åŒæ­¥èˆ‡å¸è‰²ä¸»ç¨‹å¼ï¼ˆå« PC åœ–ç‰‡åŒæ­¥ï¼‰
function syncBackgroundAndImage(fileInputId, appBgId, type) {
  const input = document.getElementById(fileInputId);
  const appImg = document.getElementById(appBgId);
  const pcImgId = (type === 'H') ? 'bgPH' : 'bgPS'; 
  const pcImg = document.getElementById(pcImgId);

  if (!input || !appImg) return;

  input.addEventListener('change', async (e) => {
    const file = e.target.files?.[0];
    if (!file) return;

    const url = await readAsDataURL(file);
    appImg.src = url;
    if (pcImg) pcImg.src = url;

    appImg.onload = function() {
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      canvas.width = 1; canvas.height = 1;
      ctx.drawImage(appImg, 0, 0, 1, 1, 0, 0, 1, 1);
      const [r, g, b] = ctx.getImageData(0, 0, 1, 1).data;
      const hex = "#" + [r, g, b].map(x => x.toString(16).padStart(2, '0')).join('');
      setBgFor(type, hex);
      if(typeof showToast === 'function') showToast(`èƒŒæ™¯åŒæ­¥å®Œæˆï¼š${hex}`);
    };
  });
}

// ç¶å®šèƒŒæ™¯ä¸Šå‚³ï¼ˆé¿å…é‡è¤‡å‘¼å« bindUploadï¼‰
syncBackgroundAndImage('bg-horiz', 'bgH', 'H');
syncBackgroundAndImage('bg-square', 'bgS', 'S');


/* ================== Logo Drag-and-Drop Sorting (APP â†” PC First Logo Sync) ================== */
(function enableLogoDragSort(){
  const container = document.getElementById('brandH');
  if (!container) return;
  const pcLogo = document.getElementById('brandPHImg');

  function refreshPc() {
    if (!pcLogo) return;
    const first = container.querySelector('img');
    if (first && first.src) pcLogo.src = first.src;
  }

  function setupImg(img){
    if (!img || img.dataset.dndReady === '1') return;
    img.dataset.dndReady = '1';
    img.setAttribute('draggable','true');
    img.style.cursor = 'grab';

    img.addEventListener('dragstart', (e)=>{
      img.classList.add('dragging');
      // Needed for Firefox to initiate a drag
      try { e.dataTransfer.setData('text/plain', ''); } catch {}
      e.dataTransfer.effectAllowed = 'move';
    });
    img.addEventListener('dragend', ()=>{
      img.classList.remove('dragging');
      refreshPc();
    });
  }

  function getDragAfterElement(container, x){
    const imgs = Array.from(container.querySelectorAll('img:not(.dragging)'));
    let closest = { offset: Number.NEGATIVE_INFINITY, element: null };
    for (const child of imgs){
      const rect = child.getBoundingClientRect();
      const offset = x - (rect.left + rect.width/2);
      if (offset < 0 && offset > closest.offset){
        closest = { offset, element: child };
      }
    }
    return closest.element;
  }

  container.addEventListener('dragover', (e)=>{
    const dragging = container.querySelector('img.dragging');
    if (!dragging) return;
    e.preventDefault();
    const after = getDragAfterElement(container, e.clientX);
    if (after == null) container.appendChild(dragging);
    else container.insertBefore(dragging, after);
  });

  // Initialize existing imgs (if any)
  Array.from(container.querySelectorAll('img')).forEach(setupImg);

  // Watch for new logos added via upload and keep PC preview synced to first logo
  const mo = new MutationObserver((muts)=>{
    let changed = false;
    for (const m of muts){
      if (m.type === 'childList'){
        Array.from(container.querySelectorAll('img')).forEach(setupImg);
        changed = true;
      }
    }
    if (changed) refreshPc();
  });
  mo.observe(container, { childList: true });

  // Initial sync (in case images already present)
  refreshPc();
})();

</script>
</body>
</html>
